# ç„¡ç•Œè¥é€  - å¿«é€Ÿä½¿ç”¨æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½²äº‘å‡½æ•°

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼Œä¾æ¬¡éƒ¨ç½²ä»¥ä¸‹äº‘å‡½æ•°ï¼š

#### 1. ç”¨æˆ·è®¤è¯ç›¸å…³
```
cloudfunctions/applyCertification/          # æäº¤è®¤è¯ç”³è¯·
cloudfunctions/reviewCertification/         # å®¡æ ¸è®¤è¯ç”³è¯·
cloudfunctions/getCertificationApplications/ # è·å–ç”³è¯·åˆ—è¡¨
cloudfunctions/getCertificationStats/       # è·å–ç»Ÿè®¡æ•°æ®
```

#### 2. å¸–å­çŠ¶æ€æµè½¬ç›¸å…³
```
cloudfunctions/addDesignerSolution/         # è®¾è®¡è€…æ·»åŠ æ–¹æ¡ˆ
cloudfunctions/createConstructionProject/   # æ–½å·¥æ–¹åˆ›å»ºé¡¹ç›®
cloudfunctions/updateConstructionProgress/  # æ›´æ–°æ–½å·¥è¿›åº¦
cloudfunctions/confirmCompletion/           # ç¡®è®¤å®Œå·¥
```

**éƒ¨ç½²æ–¹æ³•**ï¼š
1. å³é”®ç‚¹å‡»äº‘å‡½æ•°æ–‡ä»¶å¤¹
2. é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
3. ç­‰å¾…éƒ¨ç½²å®Œæˆ

---

### ç¬¬äºŒæ­¥ï¼šé…ç½®ç®¡ç†å‘˜

åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­ä¿®æ”¹ `ADMIN_OPENIDS` æ•°ç»„ï¼Œæ·»åŠ ä½ çš„ openidï¼š

```javascript
// cloudfunctions/reviewCertification/index.js
// cloudfunctions/getCertificationApplications/index.js
// cloudfunctions/getCertificationStats/index.js

const ADMIN_OPENIDS = [
  'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',  // æ›¿æ¢ä¸ºä½ çš„ openid
  'your-second-admin-openid'        // å¯ä»¥æ·»åŠ å¤šä¸ªç®¡ç†å‘˜
];
```

**å¦‚ä½•è·å– openid**ï¼š
1. åœ¨å°ç¨‹åºä¸­ç™»å½•
2. æ‰“å¼€è°ƒè¯•å™¨æ§åˆ¶å°
3. è¾“å…¥ `getApp().globalData.openid`
4. å¤åˆ¶æ˜¾ç¤ºçš„ openid

---

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•åŠŸèƒ½

#### 1. æµ‹è¯•ç”¨æˆ·è®¤è¯

**æ™®é€šç”¨æˆ·ç”³è¯·æˆä¸ºè®¾è®¡è€…**ï¼š
```
1. æ‰“å¼€å°ç¨‹åº
2. è¿›å…¥"æˆ‘çš„" -> "åˆ‡æ¢èº«ä»½"
3. é€‰æ‹©"è®¾è®¡è€…"
4. å¡«å†™è®¤è¯ä¿¡æ¯ï¼š
   - æ‰€å±æœºæ„ï¼šé•¿æ²™ç†å·¥å¤§å­¦å»ºç­‘å­¦é™¢
   - èŒç§°/èŒä½ï¼šåœ¨è¯»ç ”ç©¶ç”Ÿ
   - ä¸“ä¸šé¢†åŸŸï¼šæ— éšœç¢è®¾è®¡
5. æäº¤ç”³è¯·
```

**ç®¡ç†å‘˜å®¡æ ¸**ï¼š
```
1. è¿›å…¥"ç®¡ç†å‘˜è®¤è¯å®¡æ ¸"é¡µé¢
2. æŸ¥çœ‹å¾…å®¡æ ¸ç”³è¯·
3. ç‚¹å‡»"é€šè¿‡"æˆ–"æ‹’ç»"
```

#### 2. æµ‹è¯•å¸–å­çŠ¶æ€æµè½¬

**å‘å¸ƒé—®é¢˜**ï¼š
```
1. ç‚¹å‡»"éšæ‰‹æ‹"
2. æ‹ç…§ä¸Šä¼ 
3. é€‰æ‹©åˆ†ç±»ï¼ˆå¦‚ï¼šæ— éšœç¢å¡é“ï¼‰
4. å®šä½
5. ç”ŸæˆAIè¯Šæ–­
6. æäº¤
```

**è®¾è®¡è€…æ·»åŠ æ–¹æ¡ˆ**ï¼ˆéœ€è¦å…ˆè®¤è¯ä¸ºè®¾è®¡è€…ï¼‰ï¼š
```javascript
// åœ¨å¸–å­è¯¦æƒ…é¡µè°ƒç”¨
wx.cloud.callFunction({
  name: 'addDesignerSolution',
  data: {
    postId: 'post_xxx',
    optimizedPlan: 'å»ºè®®é‡‡ç”¨é“åˆé‡‘æè´¨ï¼Œå¡åº¦è°ƒæ•´ä¸º1:12...',
    drawings: ['cloud://design1.jpg'],
    optimizedCost: 4800,
    improvements: ['ææ–™ä¼˜åŒ–', 'å·¥æœŸç¼©çŸ­']
  }
});
```

**æ–½å·¥æ–¹åˆ›å»ºé¡¹ç›®**ï¼ˆéœ€è¦å…ˆè®¤è¯ä¸ºæ–½å·¥æ–¹ï¼‰ï¼š
```javascript
wx.cloud.callFunction({
  name: 'createConstructionProject',
  data: {
    postId: 'post_xxx'
  }
});
```

**æ›´æ–°æ–½å·¥è¿›åº¦**ï¼š
```javascript
wx.cloud.callFunction({
  name: 'updateConstructionProgress',
  data: {
    projectId: 'project_xxx',
    progress: 50,
    milestone: 'å¡é“æµ‡ç­‘å®Œæˆ',
    photos: ['cloud://progress1.jpg'],
    notes: 'æ··å‡åœŸå·²æµ‡ç­‘ï¼Œç­‰å¾…å…»æŠ¤'
  }
});
```

**ç¡®è®¤å®Œå·¥**ï¼š
```javascript
wx.cloud.callFunction({
  name: 'confirmCompletion',
  data: {
    postId: 'post_xxx',
    afterImages: ['cloud://after1.jpg'],
    feedback: 'æ”¹é€ æ•ˆæœå¾ˆå¥½ï¼Œè½®æ¤…å¯ä»¥é¡ºåˆ©é€šè¡Œ',
    rating: 5
  }
});
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨

### 1. æƒé™æ£€æŸ¥

åœ¨é¡µé¢ä¸­ä½¿ç”¨æƒé™å·¥å…·ï¼š

```javascript
const permission = require('../../utils/permission.js');

Page({
  data: {
    post: {},
    canAddDesign: false,
    canCreateProject: false,
    canUpdateProgress: false,
    canConfirm: false
  },
  
  onLoad: function(options) {
    this.loadPost(options.id);
  },
  
  loadPost: function(postId) {
    // åŠ è½½å¸–å­æ•°æ®
    wx.cloud.callFunction({
      name: 'getPublicData',
      data: { collection: 'posts', docId: postId }
    }).then(res => {
      const post = res.result.data;
      
      // æ£€æŸ¥æƒé™
      this.setData({
        post,
        canAddDesign: permission.canAddDesignSolution(post),
        canCreateProject: permission.canCreateProject(post),
        canConfirm: permission.canConfirmCompletion(post)
      });
    });
  }
});
```

### 2. æ˜¾ç¤ºå¸–å­çŠ¶æ€

```javascript
const permission = require('../../utils/permission.js');

// è·å–çŠ¶æ€æ–‡æœ¬å’Œé¢œè‰²
const statusText = permission.getStatusText(post.status);  // "å¾…å¤„ç†"
const statusColor = permission.getStatusColor(post.status); // "#F59E0B"
```

åœ¨ WXML ä¸­æ˜¾ç¤ºï¼š

```xml
<view class="status-badge" style="background-color: {{statusColor}}">
  {{statusText}}
</view>
```

### 3. æ˜¾ç¤ºæ–½å·¥è¿›åº¦

```xml
<view class="progress-section" wx:if="{{post.status === 'in_progress'}}">
  <view class="progress-bar">
    <view class="progress-fill" style="width: {{post.constructionProject.progress}}%"></view>
  </view>
  <text class="progress-text">{{post.constructionProject.progress}}%</text>
  
  <!-- é‡Œç¨‹ç¢‘åˆ—è¡¨ -->
  <view class="milestones">
    <view class="milestone" wx:for="{{post.constructionProject.milestones}}" wx:key="index">
      <text class="milestone-stage">{{item.stage}}</text>
      <text class="milestone-time">{{item.completedAt}}</text>
      <view class="milestone-photos">
        <image wx:for="{{item.photos}}" wx:key="index" src="{{item}}" mode="aspectFill"></image>
      </view>
    </view>
  </view>
</view>
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: äº‘å‡½æ•°è°ƒç”¨å¤±è´¥ï¼Œæç¤º"æƒé™ä¸è¶³"
**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç¡®è®¤å·²éƒ¨ç½²äº‘å‡½æ•°
2. ç¡®è®¤ç”¨æˆ·å·²ç™»å½•ï¼ˆæœ‰ openidï¼‰
3. ç¡®è®¤ç”¨æˆ·è§’è‰²æ­£ç¡®ï¼ˆå¦‚è®¾è®¡è€…æ‰èƒ½æ·»åŠ æ–¹æ¡ˆï¼‰
4. æ£€æŸ¥ç®¡ç†å‘˜ openid æ˜¯å¦é…ç½®æ­£ç¡®

### Q2: è®¤è¯ç”³è¯·æäº¤åçœ‹ä¸åˆ°
**A**: 
1. æ£€æŸ¥äº‘å‡½æ•° `applyCertification` æ˜¯å¦éƒ¨ç½²æˆåŠŸ
2. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æœ‰é”™è¯¯
3. ç¡®è®¤ users é›†åˆä¸­æ˜¯å¦æœ‰ certificationApplication å­—æ®µ

### Q3: å¸–å­çŠ¶æ€æ²¡æœ‰æ›´æ–°
**A**:
1. æ£€æŸ¥äº‘å‡½æ•°è¿”å›å€¼ï¼Œç¡®è®¤ success: true
2. æŸ¥çœ‹æ•°æ®åº“ï¼Œç¡®è®¤ posts é›†åˆä¸­çš„ status å­—æ®µ
3. ç¡®è®¤é¡µé¢æœ‰åˆ·æ–°æ•°æ®

### Q4: æ–½å·¥è¿›åº¦ä¸æ˜¾ç¤º
**A**:
1. ç¡®è®¤ post.constructionProject ä¸ä¸º null
2. ç¡®è®¤ milestones æ•°ç»„æœ‰æ•°æ®
3. æ£€æŸ¥ WXML ä¸­çš„æ¡ä»¶æ¸²æŸ“

---

## ğŸ“± é¡µé¢å¯¼èˆª

### ä¸»è¦é¡µé¢è·¯å¾„

```javascript
// åˆ‡æ¢èº«ä»½ï¼ˆç”³è¯·è®¤è¯ï¼‰
wx.navigateTo({ url: '/pages/switch-identity/index' });

// ç®¡ç†å‘˜è®¤è¯å®¡æ ¸
wx.navigateTo({ url: '/pages/admin-certification/index' });

// éšæ‰‹æ‹ï¼ˆå‘å¸ƒé—®é¢˜ï¼‰
wx.navigateTo({ url: '/pages/issue-edit/index' });

// å¸–å­è¯¦æƒ…
wx.navigateTo({ url: '/pages/post-detail/index?id=' + postId });

// æ–½å·¥è¿›åº¦
wx.navigateTo({ url: '/pages/construction-progress/index?id=' + projectId });

// æ¡ˆä¾‹è¯¦æƒ…
wx.navigateTo({ url: '/pages/case-detail/case-detail?postId=' + postId });
```

---

## ğŸ¨ UI ç»„ä»¶ç¤ºä¾‹

### çŠ¶æ€å¾½ç« 

```xml
<!-- WXML -->
<view class="status-badge status-{{post.status}}">
  {{statusText}}
</view>
```

```css
/* WXSS */
.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  color: white;
}

.status-pending {
  background-color: #F59E0B;
}

.status-in_progress {
  background-color: #3B82F6;
}

.status-completed {
  background-color: #10B981;
}
```

### è¿›åº¦æ¡

```xml
<!-- WXML -->
<view class="progress-container">
  <view class="progress-bar">
    <view class="progress-fill" style="width: {{progress}}%"></view>
  </view>
  <text class="progress-text">{{progress}}%</text>
</view>
```

```css
/* WXSS */
.progress-container {
  display: flex;
  align-items: center;
  gap: 12px;
}

.progress-bar {
  flex: 1;
  height: 8px;
  background-color: #E5E7EB;
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background-color: #3B82F6;
  transition: width 0.3s ease;
}

.progress-text {
  font-size: 14px;
  color: #6B7280;
  min-width: 40px;
}
```

---

## ğŸ“Š æ•°æ®æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢å¾…å¤„ç†çš„å¸–å­

```javascript
wx.cloud.callFunction({
  name: 'getPublicData',
  data: {
    collection: 'posts',
    page: 1,
    pageSize: 20,
    orderBy: 'createTime',
    order: 'desc',
    status: 'pending'  // åªæŸ¥è¯¢å¾…å¤„ç†çš„
  }
});
```

### æŸ¥è¯¢æ¡ˆä¾‹åº“

```javascript
wx.cloud.callFunction({
  name: 'getPublicData',
  data: {
    collection: 'posts',
    page: 1,
    pageSize: 20,
    orderBy: 'createTime',
    order: 'desc',
    status: 'completed',
    isCase: true,
    category: 'æ— éšœç¢å¡é“'  // æŒ‰åˆ†ç±»ç­›é€‰
  }
});
```

### æŸ¥è¯¢æˆ‘çš„æ–½å·¥é¡¹ç›®

```javascript
const openid = getApp().globalData.openid;

wx.cloud.database().collection('construction_projects')
  .where({
    constructorId: openid
  })
  .orderBy('createTime', 'desc')
  .get();
```

---

## ğŸ‰ æ­å–œï¼

ä½ å·²ç»æŒæ¡äº†ç„¡ç•Œè¥é€ å°ç¨‹åºçš„æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨æ–¹æ³•ã€‚

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- ğŸ“– å¼€å‘è¿›åº¦æŠ¥å‘Š.md
- ğŸ’» ä»£ç æ³¨é‡Š
- ğŸ› äº‘å‡½æ•°æ—¥å¿—

ç¥å¼€å‘é¡ºåˆ©ï¼ğŸš€



