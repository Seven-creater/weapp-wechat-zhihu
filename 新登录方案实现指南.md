# å¾®ä¿¡å®˜æ–¹æ¨èçš„ç™»å½•æ–¹æ¡ˆå®ç°æŒ‡å—

## ğŸ“± æ–°ç™»å½•æ–¹æ¡ˆè¯´æ˜

æ ¹æ®å¾®ä¿¡å®˜æ–¹æœ€æ–°æ”¿ç­–ï¼Œ`wx.getUserProfile` å·²è¢«åºŸå¼ƒï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

### æ–¹æ¡ˆï¼šchooseAvatar + nickname ç»„ä»¶

è¿™æ˜¯å¾®ä¿¡å®˜æ–¹æ¨èçš„æ›¿ä»£æ–¹æ¡ˆï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½ï¼Œæ— éœ€å¼¹çª—æˆæƒã€‚

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. ç™»å½•é¡µé¢
**æ–‡ä»¶ä½ç½®**ï¼š`pages/login/`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… ä½¿ç”¨ `button` ç»„ä»¶çš„ `open-type="chooseAvatar"` é€‰æ‹©å¤´åƒ
- âœ… ä½¿ç”¨ `input` ç»„ä»¶çš„ `type="nickname"` è¾“å…¥æ˜µç§°
- âœ… å¤´åƒè‡ªåŠ¨ä¸Šä¼ åˆ°äº‘å­˜å‚¨
- âœ… ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°äº‘æ•°æ®åº“
- âœ… æ”¯æŒè·³è¿‡ï¼ˆä½¿ç”¨é»˜è®¤ä¿¡æ¯ï¼‰
- âœ… ç¾è§‚çš„UIè®¾è®¡

### 2. äº‘å‡½æ•°
**å·²åˆ›å»ºçš„äº‘å‡½æ•°**ï¼š

#### updateUserInfo
- ä¿å­˜/æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- è‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–° users é›†åˆ
- å‚æ•°ï¼š`nickName`, `avatarUrl`

#### getUserInfo
- è·å–ç”¨æˆ·ä¿¡æ¯
- æ”¯æŒæŸ¥è¯¢æŒ‡å®šç”¨æˆ·æˆ–å½“å‰ç”¨æˆ·
- å‚æ•°ï¼š`openid`ï¼ˆå¯é€‰ï¼‰

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åœ¨éœ€è¦ç™»å½•çš„é¡µé¢è°ƒç”¨

```javascript
// æ£€æŸ¥æ˜¯å¦éœ€è¦ç™»å½•
const app = getApp();

Page({
  onLoad: function() {
    this.checkLogin();
  },

  checkLogin: function() {
    const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo');
    
    if (!userInfo || !userInfo.nickName) {
      // è·³è½¬åˆ°ç™»å½•é¡µé¢
      wx.navigateTo({
        url: '/pages/login/index'
      });
    }
  }
});
```

### 2. åœ¨ app.json ä¸­æ³¨å†Œé¡µé¢

```json
{
  "pages": [
    "pages/index/index",
    "pages/login/index",
    // ... å…¶ä»–é¡µé¢
  ]
}
```

### 3. éƒ¨ç½²äº‘å‡½æ•°

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. å³é”®ç‚¹å‡» `cloudfunctions/updateUserInfo`
2. é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
3. å¯¹ `getUserInfo` é‡å¤ç›¸åŒæ“ä½œ

## ğŸ“ WXML æ ¸å¿ƒä»£ç 

```xml
<!-- å¤´åƒé€‰æ‹© -->
<button 
  class="avatar-wrapper" 
  open-type="chooseAvatar" 
  bindchooseavatar="onChooseAvatar"
>
  <image class="avatar" src="{{avatarUrl}}"></image>
</button>

<!-- æ˜µç§°è¾“å…¥ -->
<input 
  type="nickname" 
  placeholder="è¯·è¾“å…¥æ˜µç§°"
  bindinput="onNicknameInput"
/>
```

## ğŸ’¡ JS æ ¸å¿ƒä»£ç 

```javascript
// é€‰æ‹©å¤´åƒ
onChooseAvatar: function(e) {
  const { avatarUrl } = e.detail;
  this.setData({ avatarUrl });
},

// è¾“å…¥æ˜µç§°
onNicknameInput: function(e) {
  const nickName = e.detail.value;
  this.setData({ nickName });
},
```

## ğŸ¨ ç‰¹æ€§

### ç”¨æˆ·ä½“éªŒ
- âœ… æ— éœ€å¼¹çª—æˆæƒï¼Œä½“éªŒæµç•…
- âœ… æ”¯æŒè·³è¿‡ï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯
- âœ… å®æ—¶é¢„è§ˆå¤´åƒå’Œæ˜µç§°
- âœ… è¡¨å•éªŒè¯ï¼Œç¡®ä¿ä¿¡æ¯å®Œæ•´

### æŠ€æœ¯ç‰¹æ€§
- âœ… å¤´åƒè‡ªåŠ¨ä¸Šä¼ åˆ°äº‘å­˜å‚¨
- âœ… ä¿¡æ¯ä¿å­˜åˆ°äº‘æ•°æ®åº“
- âœ… å…¨å±€çŠ¶æ€ç®¡ç†
- âœ… æœ¬åœ°ç¼“å­˜æ”¯æŒ
- âœ… é”™è¯¯å¤„ç†å®Œå–„

### å®‰å…¨æ€§
- âœ… æ˜µç§°é•¿åº¦é™åˆ¶ï¼ˆ2-20å­—ç¬¦ï¼‰
- âœ… å†…å®¹å®‰å…¨æ£€æµ‹ï¼ˆå¯æ‰©å±•ï¼‰
- âœ… äº‘å‡½æ•°æƒé™æ§åˆ¶

## ğŸ“Š æ•°æ®åº“ç»“æ„

### users é›†åˆ
```javascript
{
  _id: string,
  _openid: string,
  nickName: string,
  avatarUrl: string,
  userInfo: {
    nickName: string,
    avatarUrl: string,
  },
  createTime: Date,
  updateTime: Date,
}
```

## ğŸ”„ å®Œæ•´æµç¨‹

1. **ç”¨æˆ·æ‰“å¼€å°ç¨‹åº**
   - æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯
   - å¦‚æœæ²¡æœ‰ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢

2. **ç”¨æˆ·å®Œå–„ä¿¡æ¯**
   - ç‚¹å‡»å¤´åƒ â†’ é€‰æ‹©ç…§ç‰‡
   - è¾“å…¥æ˜µç§°
   - ç‚¹å‡»"å®Œæˆ"æŒ‰é’®

3. **ä¿å­˜ä¿¡æ¯**
   - ä¸Šä¼ å¤´åƒåˆ°äº‘å­˜å‚¨
   - è°ƒç”¨äº‘å‡½æ•°ä¿å­˜ä¿¡æ¯
   - æ›´æ–°å…¨å±€çŠ¶æ€å’Œæœ¬åœ°ç¼“å­˜

4. **è¿”å›åº”ç”¨**
   - è‡ªåŠ¨è¿”å›ä¸Šä¸€é¡µæˆ–é¦–é¡µ
   - ç”¨æˆ·ä¿¡æ¯å·²å¯ç”¨

## ğŸ¯ ä¸æ—§æ–¹æ¡ˆçš„å¯¹æ¯”

| ç‰¹æ€§ | æ—§æ–¹æ¡ˆ (getUserProfile) | æ–°æ–¹æ¡ˆ (chooseAvatar + nickname) |
|------|------------------------|----------------------------------|
| æˆæƒæ–¹å¼ | å¼¹çª—æˆæƒ | æ— éœ€å¼¹çª— |
| ç”¨æˆ·ä½“éªŒ | è¾ƒå·® | ä¼˜ç§€ |
| å®˜æ–¹æ”¯æŒ | å·²åºŸå¼ƒ | æ¨èä½¿ç”¨ |
| å®ç°éš¾åº¦ | ç®€å• | ç®€å• |
| çµæ´»æ€§ | ä½ | é«˜ |

## ğŸ“± æ•ˆæœé¢„è§ˆ

ç™»å½•é¡µé¢åŒ…å«ï¼š
- æ¸å˜èƒŒæ™¯
- åœ†å½¢å¤´åƒé€‰æ‹©å™¨
- æ˜µç§°è¾“å…¥æ¡†
- å®ŒæˆæŒ‰é’®ï¼ˆåŠ¨æ€æ¿€æ´»ï¼‰
- è·³è¿‡é€‰é¡¹
- æ¸©é¦¨æç¤º

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹é»˜è®¤å¤´åƒ
åœ¨ `pages/login/index.js` ä¸­ï¼š
```javascript
data: {
  avatarUrl: '/images/your-default-avatar.png',
}
```

### ä¿®æ”¹æ˜µç§°è§„åˆ™
åœ¨ `cloudfunctions/updateUserInfo/index.js` ä¸­ï¼š
```javascript
if (nickName.length > 20) {
  return { success: false, error: 'æ˜µç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦' };
}
```

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [å¾®ä¿¡å®˜æ–¹æ–‡æ¡£ - å¤´åƒæ˜µç§°å¡«å†™](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)
- [button ç»„ä»¶ - open-type](https://developers.weixin.qq.com/miniprogram/dev/component/button.html)
- [input ç»„ä»¶ - type="nickname"](https://developers.weixin.qq.com/miniprogram/dev/component/input.html)

---

**å®ç°æ—¶é—´**ï¼š2026-01-29  
**çŠ¶æ€**ï¼šâœ… å®Œæ•´å®ç°  
**å…¼å®¹æ€§**ï¼šå¾®ä¿¡åŸºç¡€åº“ 2.21.2+









