<view class="community-container">
  <!-- é¡µé¢å¤´éƒ¨ï¼šæœç´¢æ  -->
  <view class="custom-header">
    <view class="search-bar">
      <icon type="search" size="16" color="#999"></icon>
      <input
        class="search-input"
        placeholder="æœç´¢å¸–å­..."
        placeholder-class="ph-style"
        value="{{searchVal}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <view class="clear-btn" wx:if="{{searchVal}}" bindtap="onClearSearch">âœ•</view>
    </view>
    <view class="search-btn" bindtap="onSearch">æœç´¢</view>
  </view>

  <!-- å¸–å­åˆ—è¡¨ -->
  <view class="post-list">
    <view 
      class="post-card" 
      wx:for="{{posts}}" 
      wx:key="_id" 
      bindtap="goToDetail" 
      data-postid="{{item._id}}"
      aria-role="button"
      aria-label="æŸ¥çœ‹{{item.userInfo.nickName}}çš„å¸–å­ï¼š{{item.content.substring(0, 50)}}..."
    >
      <!-- 1. å¤´éƒ¨ï¼šå¤´åƒ + ä¿¡æ¯ + æ ‡ç­¾ -->
      <view class="card-header">
        <image class="avatar" src="{{item.userInfo.avatarUrl}}" mode="aspectFill"></image>
        <view class="info-box">
          <view class="name-row">
            <text class="nickname">{{item.userInfo.nickName}}</text>
            <view class="tag" wx:if="{{item.type === 'issue'}}">è·¯éšœåé¦ˆ</view>
            <view class="tag tag-help" wx:elif="{{item.type === 'help'}}">æ±‚åŠ©</view>
            <view class="tag tag-share" wx:elif="{{item.type === 'share'}}">åˆ†äº«</view>
          </view>
          <text class="time">{{item.createTime}}</text>
        </view>
      </view>

      <!-- 2. å†…å®¹åŒº -->
      <view class="card-content">
        <text class="content-text">{{item.content}}</text>
        
        <!-- æ ‡ç­¾åŒºåŸŸ -->
        <view class="post-tags" wx:if="{{item.tags && item.tags.length > 0}}">
          <view class="tag-item" wx:for="{{item.tags}}" wx:key="index" wx:for-item="tag">
            <text class="tag-text">{{tag}}</text>
          </view>
        </view>

        <!-- å®šä½ä¿¡æ¯ -->
        <view class="post-location" wx:if="{{item.address}}">
          <image class="location-icon" src="/images/location.png" aria-hidden="true"></image>
          <text class="location-text">{{item.address}}</text>
        </view>

        <!-- å›¾ç‰‡åŒºåŸŸ -->
        <view class="post-images" wx:if="{{item.images && item.images.length > 0}}">
          <view class="image-grid">
            <image 
              class="content-img" 
              wx:for="{{item.images}}" 
              wx:key="index" 
              wx:for-item="img"
              src="{{img}}" 
              mode="aspectFill"
              bindtap="previewImage"
              data-postid="{{item._id}}"
              data-current="{{img}}"
              data-urls="{{item.images}}"
              aria-label="å¸–å­å›¾ç‰‡{{index + 1}}"
            ></image>
          </view>
        </view>
      </view>

      <!-- 3. åº•éƒ¨æ“ä½œæ  -->
      <view class="card-footer">
        <view 
          class="action-btn like-btn {{item.liked ? 'liked' : ''}}" 
          catchtap="likePost" 
          data-postid="{{item._id}}" 
          data-index="{{index}}"
          aria-role="button"
          aria-label="{{item.liked ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ'}}ï¼Œå½“å‰{{item.stats.like}}ä¸ªèµ"
        >
          <text class="icon heart-icon">{{item.liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          <text class="num {{item.liked ? 'liked-text' : ''}}">{{item.stats.like}}</text>
        </view>

        <view 
          class="action-btn" 
          catchtap="goToDetail" 
          data-postid="{{item._id}}"
          aria-role="button"
          aria-label="æŸ¥çœ‹è¯„è®ºï¼Œå½“å‰{{item.stats.comment}}æ¡è¯„è®º"
        >
          <image class="icon" src="/images/comment.png" aria-hidden="true"></image>
          <text class="num">{{item.stats.comment}}</text>
        </view>

        <view 
          class="action-btn" 
          catchtap="sharePost" 
          data-postid="{{item._id}}"
          aria-role="button"
          aria-label="åˆ†äº«å¸–å­"
        >
          <image class="icon" src="/images/share.png" aria-hidden="true"></image>
          <text class="num">åˆ†äº«</text>
        </view>

        <view 
          class="action-btn collect-btn {{item.isCollected ? 'collected' : ''}}" 
          catchtap="collectPost" 
          data-postid="{{item._id}}"
          data-index="{{index}}"
          aria-role="button"
          aria-label="{{item.isCollected ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}}ï¼Œå½“å‰{{item.collectCount || 0}}äººæ”¶è—"
        >
          <text class="icon star-icon">{{item.isCollected ? 'â­' : 'â˜†'}}</text>
          <text class="num {{item.isCollected ? 'collected-text' : ''}}">{{item.collectCount || 0}}</text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view class="load-more" wx:if="{{loading}}">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    <view class="load-more" wx:if="{{!hasMore && posts.length > 0}}">
      <text class="no-more-text">æ²¡æœ‰æ›´å¤šå†…å®¹äº†</text>
    </view>
  </view>

  <!-- æ‚¬æµ®å‘å¸ƒæŒ‰é’® (FAB) -->
  <view 
    class="fab-button" 
    bindtap="goToCreatePost"
    aria-role="button"
    aria-label="å‘å¸ƒæ–°å¸–å­"
  >
    <text class="fab-icon" aria-hidden="true">+</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{posts.length === 0 && !loading}}">
    <image class="empty-icon" src="/images/empty-community.png" aria-hidden="true"></image>
    <text class="empty-text">æš‚æ— å¸–å­å†…å®¹</text>
    <text class="empty-subtext">ç‚¹å‡»ä¸‹æ–¹+æŒ‰é’®å‘å¸ƒç¬¬ä¸€æ¡å¸–å­</text>
  </view>
</view>
