<view class="post-detail-container">
  <!-- å¸–å­è¯¦æƒ…å†…å®¹ -->
  <view class="post-content-section" wx:if="{{post}}">
    <!-- å¸–å­å¤´éƒ¨ -->
    <view class="user-info-card">
      <image class="avatar" src="{{post.userInfo.avatarUrl || '/images/zhi.png'}}" mode="aspectFill" aria-hidden="true" bindtap="navigateToProfile" data-id="{{post._openid}}"></image>
      
      <view class="info-right">
        <!-- ç¬¬ä¸€è¡Œï¼šåå­— + æ ‡ç­¾ -->
        <view class="name-row">
          <view bindtap="navigateToProfile" data-id="{{post._openid}}">
            <user-name 
              nickName="{{post.userInfo.nickName}}" 
              userType="{{post.userType}}"
              inline="{{true}}"
            />
          </view>
          <view class="follow-btn {{isFollowing ? 'followed' : ''}}" bindtap="toggleFollow" wx:if="{{!post.isOwner}}">
            {{isFollowing ? 'å·²å…³æ³¨' : 'å…³æ³¨'}}
          </view>
          <view class="tag-badge" wx:if="{{post.type === 'issue'}}">
            <text class="tag-icon">ğŸš§</text>
            <text>{{post.categoryName || 'éšæ‰‹æ‹'}}</text>
          </view>
          <view class="tag-badge" wx:elif="{{post.type === 'case'}}">
            <text class="tag-icon">ğŸ—ï¸</text>
            <text>{{post.categoryName || 'æ¡ˆä¾‹'}}</text>
          </view>
          <view class="tag-badge tag-share" wx:elif="{{post.type === 'community'}}">
            <text class="tag-icon">ğŸ’¬</text>
            <text>ç¤¾åŒº</text>
          </view>
          <view class="tag-badge tag-help" wx:elif="{{post.type === 'help'}}">
            <text class="tag-icon">â“</text>
            <text>æ±‚åŠ©</text>
          </view>
          <view class="tag-badge tag-share" wx:elif="{{post.type === 'share'}}">
            <text class="tag-icon">ğŸ’¬</text>
            <text>åˆ†äº«</text>
          </view>
        </view>
        
        <!-- ç¬¬äºŒè¡Œï¼šæ—¶é—´ + åˆ é™¤æŒ‰é’® -->
        <view class="time-row">
          <text class="time">{{post.createTime}}</text>
          
          <!-- åˆ é™¤æŒ‰é’®ï¼šçº¢è‰²åœ†è§’æ ·å¼ï¼ˆä½œè€…æˆ–ç®¡ç†å‘˜å¯è§ï¼‰ -->
          <view 
            class="delete-btn" 
            bindtap="deletePost" 
            wx:if="{{post.canDelete}}"
            data-postid="{{post._id}}"
            aria-role="button"
            aria-label="åˆ é™¤å¸–å­"
          >
            <text>åˆ é™¤</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¸–å­å†…å®¹åŒº -->
    <view class="content-body">
      <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šç”¨æˆ·å‘å¸ƒçš„å†…å®¹ -->
      <view class="user-text-section">
        <text class="user-text" user-select="true">{{post.content}}</text>
      </view>

      <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šAI è¯Šæ–­å¡ç‰‡ (å®Œå…¨ç‹¬ç«‹ï¼Œå¸¦èƒŒæ™¯è‰²) -->
      <view class="ai-report-card" wx:if="{{post.aiDiagnosis || post.aiSolution}}">
        <view class="ai-header">
          <text class="ai-icon">ğŸ¤–</text>
          <text class="ai-title">AI æ™ºèƒ½è¯Šæ–­</text>
        </view>
        <view class="ai-content">
          <text user-select="true">{{post.aiDiagnosis || post.aiSolution}}</text>
        </view>
      </view>
    </view>

    <!-- ç”¨æˆ·å»ºè®® -->
      <view class="user-suggestion-block" wx:if="{{post.userSuggestion && post.userSuggestion.length > 0}}">
        <view class="suggestion-blue-line"></view>
        <view class="suggestion-content">
          <text class="suggestion-label">ğŸ‘¤ æˆ‘çš„å»ºè®®</text>
          <text class="suggestion-text" user-select="true">{{post.userSuggestion}}</text>
        </view>
      </view>

    <!-- å®šä½ä¿¡æ¯ -->
    <view class="location-card" wx:if="{{post.address || post.formattedAddress}}">
      <image class="location-icon" src="/images/flag.png" aria-hidden="true"></image>
      <view class="location-info">
        <view class="location-header">
          <image class="location-pin-icon" src="/images/flag.png" aria-hidden="true"></image>
          <text class="location-label">ä½ç½®</text>
        </view>
        <text class="location-text">{{post.formattedAddress || post.address}}</text>
        <text class="detail-address-text" wx:if="{{post.detailAddress}}">{{post.detailAddress}}</text>
      </view>
    </view>

    <!-- å›¾ç‰‡å±•ç¤º -->
    <view class="post-images" wx:if="{{post.images && post.images.length > 0}}">
      <view class="image-grid">
        <image 
          class="post-image" 
          wx:for="{{post.images}}" 
          wx:key="index" 
          wx:for-item="img"
          src="{{img}}" 
          mode="aspectFill"
          bindtap="previewImage"
          data-current="{{img}}"
          data-urls="{{post.images}}"
          aria-label="å¸–å­å›¾ç‰‡{{index + 1}}"
        ></image>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="post-actions">
      <view 
        class="action-btn like-btn {{isLiked ? 'liked' : ''}}" 
        bindtap="likePost"
        aria-role="button"
        aria-label="{{isLiked ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ'}}ï¼Œå½“å‰{{likeCount}}ä¸ªèµ"
      >
        <text class="action-icon heart-icon">{{isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        <text class="action-text {{isLiked ? 'liked-text' : ''}}">{{likeCount}}</text>
      </view>

      <view 
        class="action-btn comment-btn" 
        bindtap="showCommentInput"
        aria-role="button"
        aria-label="å‘è¡¨è¯„è®ºï¼Œå½“å‰{{post.stats.comment}}æ¡è¯„è®º"
      >
        <text class="action-icon comment-icon">ğŸ’¬</text>
        <text class="action-text">{{post.stats.comment}}</text>
      </view>

      <view 
        class="action-btn collect-btn {{isCollected ? 'collected' : ''}}" 
        bindtap="toggleCollect"
        aria-role="button"
        aria-label="{{isCollected ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}}ï¼Œå½“å‰{{collectCount}}äººæ”¶è—"
      >
        <text class="action-icon star-icon">{{isCollected ? 'â­' : 'â˜†'}}</text>
        <text class="action-text">{{collectCount}}</text>
      </view>
    </view>

    <!-- ğŸ†• ä¸“ä¸šç”¨æˆ·æ“ä½œåŒºï¼ˆä»…é—®é¢˜å¸–æ˜¾ç¤ºï¼‰ -->
    <view class="professional-actions" wx:if="{{showProfessionalActions}}">
      <view class="section-divider"></view>
      <view class="professional-title">
        <text class="title-icon">ğŸ”§</text>
        <text class="title-text">ä¸“ä¸šæ“ä½œ</text>
        <text class="status-badge status-{{post.status}}">
          {{post.status === 'pending' ? 'å¾…å¤„ç†' : post.status === 'processing' ? 'å¤„ç†ä¸­' : 'å·²å®Œæˆ'}}
        </text>
      </view>
      
      <!-- å…³è”å†…å®¹å±•ç¤ºï¼ˆæ‰€æœ‰è§’è‰²éƒ½èƒ½çœ‹åˆ°ï¼‰ -->
      <view class="linked-content">
        <!-- è®¾è®¡æ–¹æ¡ˆ -->
        <view class="linked-item" wx:if="{{proposalCount > 0}}" bindtap="viewProposalList">
          <text class="linked-icon">ğŸ“</text>
          <view class="linked-info">
            <text class="linked-title">è®¾è®¡æ–¹æ¡ˆ</text>
            <text class="linked-desc">å·²æœ‰ {{proposalCount}} ä¸ªè®¾è®¡æ–¹æ¡ˆ</text>
          </view>
          <text class="linked-arrow">â€º</text>
        </view>
        
        <!-- æ–½å·¥é¡¹ç›®ï¼ˆæ˜¾ç¤ºæ–½å·¥èŠ‚ç‚¹è¿›åº¦ï¼‰ -->
        <view class="linked-item" wx:if="{{linkedProject}}" bindtap="viewProject">
          <text class="linked-icon">ğŸ—ï¸</text>
          <view class="linked-info">
            <text class="linked-title">æ–½å·¥é¡¹ç›®</text>
            <text class="linked-desc">{{linkedProject.contractorName || 'æ–½å·¥æ–¹'}} Â· {{linkedProject.currentStage || 'å‡†å¤‡é˜¶æ®µ'}}</text>
          </view>
          <text class="linked-arrow">â€º</text>
        </view>
        
        <!-- æš‚æ— å…³è”å†…å®¹æç¤º -->
        <view class="no-linked-content" wx:if="{{proposalCount === 0 && !linkedProject}}">
          <text class="no-content-icon">ğŸ“‹</text>
          <text class="no-content-text">æš‚æ— å…³è”çš„è®¾è®¡æ–¹æ¡ˆæˆ–æ–½å·¥é¡¹ç›®</text>
        </view>
      </view>
      
      <!-- æ“ä½œæŒ‰é’®åŒºï¼ˆæ ¹æ®è§’è‰²æ˜¾ç¤ºï¼‰ -->
      <view class="professional-buttons">
        <!-- è®¾è®¡å¸ˆåŠŸèƒ½ -->
        <block wx:if="{{isDesigner}}">
          <!-- æ·»åŠ è®¾è®¡æ–¹æ¡ˆæŒ‰é’® -->
          <view 
            class="pro-btn design-btn" 
            bindtap="addDesignSolution"
            wx:if="{{proposalCount === 0}}"
          >
            <text class="pro-icon">ğŸ“</text>
            <text class="pro-text">æ·»åŠ è®¾è®¡æ–¹æ¡ˆ</text>
          </view>
        </block>
        
        <!-- æ–½å·¥æ–¹åŠŸèƒ½ -->
        <block wx:if="{{isContractor}}">
          <!-- åˆ›å»ºé¡¹ç›®æŒ‰é’® -->
          <view 
            class="pro-btn project-btn" 
            bindtap="createProject"
            wx:if="{{!linkedProject}}"
          >
            <text class="pro-icon">ğŸ—ï¸</text>
            <text class="pro-text">åˆ›å»ºé¡¹ç›®</text>
          </view>
          
          <!-- æ›´æ–°æ–½å·¥èŠ‚ç‚¹æŒ‰é’® -->
          <view 
            class="pro-btn update-btn" 
            bindtap="updateProjectNode"
            wx:if="{{linkedProject && post.status === 'processing'}}"
          >
            <text class="pro-icon">ğŸ“¸</text>
            <text class="pro-text">æ›´æ–°æ–½å·¥èŠ‚ç‚¹</text>
          </view>
        </block>
        
        <!-- æ–½å·¥æ–¹åŠŸèƒ½ -->
        <block wx:if="{{isContractor}}">
          <!-- æŸ¥çœ‹è”ç³»æ–¹å¼æŒ‰é’® -->
          <view 
            class="pro-btn contact-btn" 
            bindtap="viewContactInfo"
          >
            <text class="pro-icon">ğŸ“</text>
            <text class="pro-text">æŸ¥çœ‹è”ç³»æ–¹å¼</text>
          </view>
        </block>
        
        <!-- ç¤¾åŒºå·¥ä½œè€…åŠŸèƒ½ -->
        <block wx:if="{{isCommunityWorker}}">
          <!-- æŸ¥çœ‹è”ç³»æ–¹å¼æŒ‰é’® -->
          <view 
            class="pro-btn contact-btn" 
            bindtap="viewContactInfo"
          >
            <text class="pro-icon">ğŸ“</text>
            <text class="pro-text">æŸ¥çœ‹è”ç³»æ–¹å¼</text>
          </view>
          
          <!-- ç¡®è®¤å®ŒæˆæŒ‰é’® -->
          <view 
            class="pro-btn complete-btn" 
            bindtap="confirmProjectCompletion"
            wx:if="{{linkedProject && post.status === 'processing'}}"
          >
            <text class="pro-icon">âœ…</text>
            <text class="pro-text">ç¡®è®¤é¡¹ç›®å®Œæˆ</text>
          </view>
        </block>
        
        <!-- å‘å¸–è€…åŠŸèƒ½ -->
        <block wx:if="{{isPostOwner && !isCommunityWorker}}">
          <!-- ç¡®è®¤å®ŒæˆæŒ‰é’® -->
          <view 
            class="pro-btn complete-btn" 
            bindtap="confirmProjectCompletion"
            wx:if="{{linkedProject && post.status === 'processing'}}"
          >
            <text class="pro-icon">âœ…</text>
            <text class="pro-text">ç¡®è®¤é¡¹ç›®å®Œæˆ</text>
          </view>
        </block>
        
        <!-- å·²å®Œæˆæ ‡è¯†ï¼ˆæ‰€æœ‰è§’è‰²éƒ½èƒ½çœ‹åˆ°ï¼‰ -->
        <view class="pro-btn completed-badge" wx:if="{{post.status === 'completed'}}">
          <text class="pro-icon">ğŸ‰</text>
          <text class="pro-text">é¡¹ç›®å·²å®Œæˆ</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºåŒº -->
  <view class="comments-section">
    <view class="section-header">
      <text class="section-title">è¯„è®º</text>
      <text class="comment-count">{{comments.length}}æ¡</text>
    </view>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <view class="comments-list">
      <view class="comment-item" wx:for="{{comments}}" wx:key="_id">
        <!-- ä¸»è¯„è®º -->
        <view class="main-comment">
          <image class="comment-avatar" src="{{item.userInfo.avatarUrl || '/images/zhi.png'}}" aria-hidden="true" bindtap="navigateToUserProfile" data-openid="{{item._openid}}"></image>
          <view class="comment-content">
            <view class="comment-header">
              <view class="comment-author-wrapper">
                <user-name 
                  nickName="{{item.userInfo.nickName}}" 
                  userType="{{item.userType}}"
                  inline="{{true}}"
                  vertical="{{true}}"
                />
              </view>
              <text class="comment-time">{{item.createTime}}</text>
            </view>
            <text class="comment-text" user-select="true">{{item.content}}</text>
            <view class="comment-actions">
              <view
                class="comment-action like-action {{item.liked ? 'liked' : ''}}"
                bindtap="likeComment"
                data-commentid="{{item._id}}"
                aria-role="button"
                aria-label="{{item.liked ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ'}}è¯„è®ºï¼Œå½“å‰{{item.likes}}ä¸ªèµ"
              >
                <text class="action-icon heart-icon">{{item.liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
                <text class="action-text">{{item.likes}}</text>
              </view>
              <view
                class="comment-action reply-action"
                bindtap="showCommentInput"
                data-replyto="{{item._id}}"
                data-replyname="{{item.userInfo.nickName}}"
                aria-role="button"
                aria-label="å›å¤{{item.userInfo.nickName}}çš„è¯„è®º"
              >
                <text class="action-text">å›å¤</text>
              </view>
              <view
                class="comment-action delete-action"
                wx:if="{{item.canDelete}}"
                bindtap="deleteComment"
                data-commentid="{{item._id}}"
                aria-role="button"
                aria-label="åˆ é™¤è¯„è®º"
              >
                <text class="action-text">åˆ é™¤</text>
              </view>
            </view>
          </view>
        </view>

        <!-- å›å¤åˆ—è¡¨ -->
        <view class="replies-list" wx:if="{{item.replies && item.replies.length > 0}}">
          <view class="reply-item" wx:for="{{item.replies}}" wx:key="_id" wx:for-item="reply">
            <image class="reply-avatar" src="{{reply.userInfo.avatarUrl || '/images/zhi.png'}}" aria-hidden="true" bindtap="navigateToUserProfile" data-openid="{{reply._openid}}"></image>
            <view class="reply-content">
              <view class="reply-header">
                <view class="reply-author-wrapper">
                  <user-name 
                    nickName="{{reply.userInfo.nickName}}" 
                    userType="{{reply.userType}}"
                    inline="{{true}}"
                    vertical="{{true}}"
                  />
                </view>
                <text class="reply-time">{{reply.createTime}}</text>
              </view>
              <text class="reply-text" user-select="true">{{reply.content}}</text>
              <view class="reply-actions">
                <view 
                  class="reply-action like-action {{reply.liked ? 'liked' : ''}}" 
                  bindtap="likeComment" 
                  data-commentid="{{reply._id}}" 
                  data-isreply="true" 
                  data-parentid="{{reply.parentId}}"
                  aria-role="button"
                  aria-label="{{reply.liked ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ'}}å›å¤ï¼Œå½“å‰{{reply.likes}}ä¸ªèµ"
                >
                  <text class="action-icon heart-icon">{{reply.liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
                  <text class="action-text">{{reply.likes}}</text>
                </view>
                <view
                  class="reply-action reply-action"
                  bindtap="showCommentInput"
                  data-replyto="{{reply._id}}"
                  data-replyname="{{reply.userInfo.nickName}}"
                  aria-role="button"
                  aria-label="å›å¤{{reply.userInfo.nickName}}çš„è¯„è®º"
                >
                  <text class="action-text">å›å¤</text>
                </view>
                <view
                  class="reply-action delete-action"
                  wx:if="{{reply.canDelete}}"
                  bindtap="deleteComment"
                  data-commentid="{{reply._id}}"
                  data-isreply="true"
                  data-parentid="{{reply.parentId}}"
                  aria-role="button"
                  aria-label="åˆ é™¤å›å¤"
                >
                  <text class="action-text">åˆ é™¤</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºè¯„è®ºçŠ¶æ€ -->
    <view class="empty-comments" wx:if="{{comments.length === 0}}">
      <image class="empty-icon" src="/images/empty-comments.png" aria-hidden="true"></image>
      <text class="empty-text">æš‚æ— è¯„è®º</text>
      <text class="empty-subtext">å¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§</text>
    </view>
  </view>

  <!-- åº•éƒ¨è¯„è®ºè¾“å…¥æ  -->
  <view class="footer-input-bar">
    <view class="input-wrapper">
      <input 
        id="comment-input"
        class="input-field" 
        placeholder="{{placeholderText}}" 
        placeholder-style="color: #999;" 
        focus="{{isInputFocus}}"
        bindinput="onCommentInput"
        bindblur="onInputBlur"
        value="{{newComment}}"
        confirm-type="send"
        bindconfirm="submitComment"
        aria-label="è¯„è®ºè¾“å…¥æ¡†"
      />
    </view>
    <view class="send-btn" bindtap="submitComment" aria-role="button" aria-label="å‘é€è¯„è®º">å‘é€</view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>
