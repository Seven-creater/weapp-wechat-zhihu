<!--pages/route/plan/index.wxml-->
<view class="container">
  <!-- åœ°å›¾ -->
  <map
    id="routeMap"
    class="map-view"
    longitude="{{longitude}}"
    latitude="{{latitude}}"
    scale="{{scale}}"
    markers="{{markers}}"
    polyline="{{polyline}}"
    show-location
  >
    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <cover-view class="top-controls">
      <cover-view class="location-inputs">
        <!-- èµ·ç‚¹ -->
        <cover-view class="input-row" bindtap="chooseStartLocation">
          <cover-view class="input-icon start-icon">ğŸŸ¢</cover-view>
          <cover-view class="input-text">{{startAddress}}</cover-view>
        </cover-view>
        
        <!-- äº¤æ¢æŒ‰é’® -->
        <cover-view class="swap-btn" bindtap="swapLocations">
          <cover-view class="swap-icon">â‡…</cover-view>
        </cover-view>
        
        <!-- ç»ˆç‚¹ -->
        <cover-view class="input-row" bindtap="chooseEndLocation">
          <cover-view class="input-icon end-icon">ğŸ”´</cover-view>
          <cover-view class="input-text">{{endAddress || 'é€‰æ‹©ç›®çš„åœ°'}}</cover-view>
        </cover-view>
      </cover-view>
      
      <!-- è§„åˆ’æŒ‰é’® -->
      <cover-view class="plan-btn" bindtap="planRoute">
        <cover-view class="plan-text">{{planning ? 'è§„åˆ’ä¸­...' : 'å¼€å§‹è§„åˆ’'}}</cover-view>
      </cover-view>
    </cover-view>
  </map>

  <!-- åº•éƒ¨è·¯çº¿æ–¹æ¡ˆ -->
  <view class="bottom-panel" wx:if="{{routes.length > 0}}">
    <!-- è·¯çº¿é€‰é¡¹å¡ -->
    <scroll-view scroll-x class="route-tabs" enable-flex>
      <view
        wx:for="{{routes}}"
        wx:key="index"
        class="route-tab {{selectedRouteIndex === index ? 'active' : ''}}"
        bindtap="selectRoute"
        data-index="{{index}}"
      >
        <view class="tab-name">{{item.name}}</view>
        <view class="tab-info">
          <text class="tab-distance">{{formatDistance(item.distance)}}</text>
          <text class="tab-duration">{{formatDuration(item.duration)}}</text>
        </view>
        <view class="tab-score" style="color: {{getScoreColor(item.score)}}">
          è¯„åˆ†: {{item.score}}
        </view>
      </view>
    </scroll-view>

    <!-- è·¯çº¿è¯¦æƒ… -->
    <view class="route-detail" wx:if="{{routes[selectedRouteIndex]}}">
      <view class="detail-header">
        <view class="header-left">
          <text class="route-name">{{routes[selectedRouteIndex].name}}</text>
          <text class="route-type">{{routes[selectedRouteIndex].type === 'recommended' ? 'æ¨è' : routes[selectedRouteIndex].type === 'shortest' ? 'æœ€çŸ­' : 'æ— éšœç¢'}}</text>
        </view>
        <view class="header-right">
          <text class="route-distance">{{formatDistance(routes[selectedRouteIndex].distance)}}</text>
          <text class="route-duration">çº¦{{formatDuration(routes[selectedRouteIndex].duration)}}</text>
        </view>
      </view>

      <!-- è­¦å‘Šä¿¡æ¯ -->
      <view wx:if="{{routes[selectedRouteIndex].warnings.length > 0}}" class="warnings-section">
        <view wx:for="{{routes[selectedRouteIndex].warnings}}" wx:key="index" class="warning-item">
          <text class="warning-icon">âš ï¸</text>
          <text class="warning-text">{{item.message}}</text>
        </view>
      </view>

      <!-- é€”ç»è®¾æ–½ -->
      <view wx:if="{{routes[selectedRouteIndex].facilities.length > 0}}" class="facilities-section">
        <view class="section-title">é€”ç»è®¾æ–½ ({{routes[selectedRouteIndex].facilities.length}})</view>
        <scroll-view scroll-x class="facilities-scroll" enable-flex>
          <view
            wx:for="{{routes[selectedRouteIndex].facilities}}"
            wx:key="id"
            class="facility-chip {{item.status}}"
          >
            <text class="chip-icon">
              {{item.status === 'accessible' ? 'âœ…' : item.status === 'blocked' ? 'ğŸš«' : item.status === 'maintenance' ? 'ğŸ”§' : 'âš ï¸'}}
            </text>
            <text class="chip-name">{{item.name}}</text>
          </view>
        </scroll-view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <button class="action-btn secondary" bindtap="useWechatMap">
          <text class="btn-icon">ğŸ—ºï¸</text>
          <text>å¾®ä¿¡åœ°å›¾</text>
        </button>
        <button class="action-btn primary" bindtap="startNavigation">
          <text class="btn-icon">ğŸ§­</text>
          <text>å¼€å§‹å¯¼èˆª</text>
        </button>
      </view>
    </view>

    <!-- è®¾æ–½åˆ†æ -->
    <view wx:if="{{facilityAnalysis}}" class="analysis-section">
      <view class="analysis-title">è·¯çº¿åˆ†æ</view>
      <view class="analysis-stats">
        <view class="stat-item">
          <text class="stat-value">{{facilityAnalysis.total}}</text>
          <text class="stat-label">æ€»è®¾æ–½</text>
        </view>
        <view class="stat-item green">
          <text class="stat-value">{{facilityAnalysis.accessible}}</text>
          <text class="stat-label">å¯é€šè¡Œ</text>
        </view>
        <view class="stat-item red">
          <text class="stat-value">{{facilityAnalysis.blocked}}</text>
          <text class="stat-label">éšœç¢ç‚¹</text>
        </view>
        <view class="stat-item yellow">
          <text class="stat-value">{{facilityAnalysis.maintenance}}</text>
          <text class="stat-label">ç»´ä¿®ä¸­</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{routes.length === 0 && !planning}}">
    <image class="empty-icon" src="/images/icon_route.png" mode="aspectFit" />
    <text class="empty-text">é€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œå¼€å§‹è§„åˆ’æ— éšœç¢è·¯çº¿</text>
  </view>
</view>

