<!--pages/facility/detail/index.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- è®¾æ–½è¯¦æƒ… -->
  <view wx:else class="detail-content">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <view class="header-section">
      <view class="status-badge" style="background-color: {{getStatusInfo(facility.status).color}}">
        <text class="status-icon">{{getStatusInfo(facility.status).icon}}</text>
        <text class="status-label">{{getStatusInfo(facility.status).label}}</text>
      </view>
      
      <view class="facility-name">{{facility.name}}</view>
      <view class="facility-address">{{facility.formattedAddress || facility.address}}</view>
    </view>

    <!-- ç…§ç‰‡å±•ç¤º -->
    <view wx:if="{{facility.images && facility.images.length > 0}}" class="images-section">
      <view class="section-title">ç°åœºç…§ç‰‡</view>
      <view class="images-grid">
        <image 
          wx:for="{{facility.images}}" 
          wx:key="index"
          class="facility-image"
          src="{{item}}" 
          mode="aspectFill"
          bindtap="previewImage"
          data-src="{{item}}"
        />
      </view>
    </view>

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-section">
      <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
      
      <view class="info-item">
        <text class="info-label">è®¾æ–½ç±»å‹</text>
        <text class="info-value">{{facility.type}}</text>
      </view>
      
      <view class="info-item">
        <text class="info-label">å½“å‰çŠ¶æ€</text>
        <text class="info-value" style="color: {{getStatusInfo(facility.status).color}}">
          {{getStatusInfo(facility.status).label}}
        </text>
      </view>
      
      <view wx:if="{{facility.description}}" class="info-item">
        <text class="info-label">è¯¦ç»†æè¿°</text>
        <text class="info-value description">{{facility.description}}</text>
      </view>
      
      <view class="info-item">
        <text class="info-label">åˆ›å»ºæ—¶é—´</text>
        <text class="info-value">{{facility.createTime}}</text>
      </view>
      
      <view class="info-item">
        <text class="info-label">æœ€åæ›´æ–°</text>
        <text class="info-value">{{facility.updateTime}}</text>
      </view>
    </view>

    <!-- çŠ¶æ€å†å² -->
    <view wx:if="{{facility.statusHistory && facility.statusHistory.length > 0}}" class="history-section">
      <view class="section-title">çŠ¶æ€å†å²</view>
      
      <view class="history-timeline">
        <view wx:for="{{facility.statusHistory}}" wx:key="index" class="history-item">
          <view class="history-dot" style="background-color: {{getStatusInfo(item.status).color}}"></view>
          <view class="history-line" wx:if="{{index < facility.statusHistory.length - 1}}"></view>
          
          <view class="history-content">
            <view class="history-header">
              <text class="history-status" style="color: {{getStatusInfo(item.status).color}}">
                {{getStatusInfo(item.status).icon}} {{getStatusInfo(item.status).label}}
              </text>
              <text class="history-time">{{item.updateTime}}</text>
            </view>
            
            <view wx:if="{{item.notes}}" class="history-notes">{{item.notes}}</view>
            
            <view wx:if="{{item.images && item.images.length > 0}}" class="history-images">
              <image 
                wx:for="{{item.images}}" 
                wx:for-item="img"
                wx:key="index"
                class="history-image"
                src="{{img}}" 
                mode="aspectFill"
                bindtap="previewHistoryImage"
                data-src="{{img}}"
                data-images="{{item.images}}"
              />
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="actions-section">
      <button class="action-btn primary" bindtap="navigateToFacility">
        <text class="btn-icon">ğŸ“</text>
        <text>å¯¼èˆªåˆ°æ­¤</text>
      </button>
      
      <button wx:if="{{canUpdate}}" class="action-btn secondary" bindtap="showUpdateStatusPanel">
        <text class="btn-icon">ğŸ”„</text>
        <text>æ›´æ–°çŠ¶æ€</text>
      </button>
      
      <button class="action-btn danger" bindtap="reportFacility">
        <text class="btn-icon">âš ï¸</text>
        <text>ä¸¾æŠ¥</text>
      </button>
    </view>
  </view>

  <!-- æ›´æ–°çŠ¶æ€é¢æ¿ -->
  <view wx:if="{{showUpdatePanel}}" class="update-panel">
    <view class="panel-mask" bindtap="closeUpdatePanel"></view>
    
    <view class="panel-content">
      <view class="panel-header">
        <text class="panel-title">æ›´æ–°è®¾æ–½çŠ¶æ€</text>
        <text class="panel-close" bindtap="closeUpdatePanel">âœ•</text>
      </view>

      <view class="panel-body">
        <!-- çŠ¶æ€é€‰æ‹© -->
        <view class="form-group">
          <text class="form-label">é€‰æ‹©æ–°çŠ¶æ€</text>
          <view class="status-options">
            <view 
              wx:for="{{statusOptions}}" 
              wx:key="value"
              class="status-option {{selectedNewStatus === item.value ? 'active' : ''}}"
              style="border-color: {{item.color}}"
              bindtap="onNewStatusTap"
              data-status="{{item.value}}"
            >
              <text class="option-icon">{{item.icon}}</text>
              <text class="option-label">{{item.label}}</text>
            </view>
          </view>
        </view>

        <!-- å¤‡æ³¨ -->
        <view class="form-group">
          <text class="form-label">å¤‡æ³¨è¯´æ˜ï¼ˆå¯é€‰ï¼‰</text>
          <textarea 
            class="form-textarea"
            placeholder="è¯·æè¿°å½“å‰çŠ¶æ€çš„è¯¦ç»†æƒ…å†µ..."
            value="{{updateNotes}}"
            bindinput="onUpdateNotesInput"
            maxlength="200"
          />
        </view>

        <!-- ç…§ç‰‡ä¸Šä¼  -->
        <view class="form-group">
          <text class="form-label">ä¸Šä¼ ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰</text>
          <view class="update-images-grid">
            <view wx:for="{{updateImages}}" wx:key="index" class="update-image-item">
              <image class="update-image" src="{{item}}" mode="aspectFill" />
              <view class="remove-image" bindtap="removeUpdateImage" data-index="{{index}}">âœ•</view>
            </view>
            
            <view wx:if="{{updateImages.length < 9}}" class="add-image-btn" bindtap="chooseUpdateImage">
              <text class="add-icon">+</text>
              <text class="add-text">æ·»åŠ ç…§ç‰‡</text>
            </view>
          </view>
        </view>
      </view>

      <view class="panel-footer">
        <button class="cancel-btn" bindtap="closeUpdatePanel">å–æ¶ˆ</button>
        <button 
          class="submit-btn" 
          bindtap="submitStatusUpdate"
          disabled="{{updating}}"
        >
          {{updating ? 'æäº¤ä¸­...' : 'æäº¤æ›´æ–°'}}
        </button>
      </view>
    </view>
  </view>
</view>

