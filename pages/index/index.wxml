<view class="map-home-container">
  <view wx:if="{{!searchVisible}}" class="content">
    <view class="map-area">
      <map
        id="mainMap"
        class="map-view"
        longitude="{{longitude}}"
        latitude="{{latitude}}"
        scale="{{scale}}"
        markers="{{markers}}"
        show-location
        bindmarkertap="handleMarkerTap"
        bindlongpress="onMapLongPress"
      >
        <cover-view class="top-bar" style="top: {{topInset}}px;">
          <cover-view class="location-selector" bindtap="onCenterTap">
            <cover-image class="location-icon" src="/images/flag.png" />
            <cover-view class="location-text">é™„è¿‘</cover-view>
            <cover-view class="arrow-down">â–¼</cover-view>
          </cover-view>
          <cover-view class="search-box" bindtap="onSearchTap">
            <cover-image class="search-icon" src="/images/search.png" />
            <cover-view class="search-placeholder">è¯·è¾“å…¥æ‚¨æƒ³å»çš„åœ°ç‚¹</cover-view>
          </cover-view>
        </cover-view>

        <cover-view class="map-controls">
          <cover-view class="control-btn" bindtap="openRoutePlanning">
            <cover-view class="control-icon-text">ğŸ§­</cover-view>
            <cover-view class="control-text">è·¯çº¿</cover-view>
          </cover-view>
          <cover-view class="control-btn" bindtap="toggleStatusFilter">
            <cover-view class="control-icon-text">ğŸ”</cover-view>
            <cover-view class="control-text">ç­›é€‰</cover-view>
            <cover-view wx:if="{{statusFilter.length > 0}}" class="filter-badge">{{statusFilter.length}}</cover-view>
          </cover-view>
          <cover-view class="control-btn" bindtap="onLayerTap">
            <cover-image class="control-icon" src="/images/icon_layer.png" />
            <cover-view class="control-text">å›¾å±‚</cover-view>
          </cover-view>
          <cover-view class="control-btn" bindtap="onCenterTap">
            <cover-image class="control-icon" src="/images/icon_center.png" />
            <cover-view class="control-text">å±…ä¸­</cover-view>
          </cover-view>
        </cover-view>

        <!-- çŠ¶æ€ç­›é€‰é¢æ¿ -->
        <cover-view wx:if="{{showStatusFilter}}" class="status-filter-panel">
          <cover-view class="filter-header">
            <cover-view class="filter-title">è®¾æ–½çŠ¶æ€ç­›é€‰</cover-view>
            <cover-view class="filter-close" bindtap="toggleStatusFilter">âœ•</cover-view>
          </cover-view>
          
          <cover-view class="filter-options">
            <cover-view 
              class="filter-option {{statusFilter.indexOf('accessible') > -1 ? 'active' : ''}}"
              bindtap="onStatusFilterTap"
              data-status="accessible"
            >
              <cover-view class="option-icon" style="background-color: #10b981;">âœ…</cover-view>
              <cover-view class="option-label">å¯é€šè¡Œ</cover-view>
            </cover-view>
            
            <cover-view 
              class="filter-option {{statusFilter.indexOf('blocked') > -1 ? 'active' : ''}}"
              bindtap="onStatusFilterTap"
              data-status="blocked"
            >
              <cover-view class="option-icon" style="background-color: #ef4444;">ğŸš«</cover-view>
              <cover-view class="option-label">éšœç¢ç‚¹</cover-view>
            </cover-view>
            
            <cover-view 
              class="filter-option {{statusFilter.indexOf('maintenance') > -1 ? 'active' : ''}}"
              bindtap="onStatusFilterTap"
              data-status="maintenance"
            >
              <cover-view class="option-icon" style="background-color: #f59e0b;">ğŸ”§</cover-view>
              <cover-view class="option-label">ç»´ä¿®ä¸­</cover-view>
            </cover-view>
            
            <cover-view 
              class="filter-option {{statusFilter.indexOf('occupied') > -1 ? 'active' : ''}}"
              bindtap="onStatusFilterTap"
              data-status="occupied"
            >
              <cover-view class="option-icon" style="background-color: #f97316;">âš ï¸</cover-view>
              <cover-view class="option-label">è¢«å ç”¨</cover-view>
            </cover-view>
          </cover-view>
          
          <cover-view class="filter-actions">
            <cover-view class="filter-clear" bindtap="clearStatusFilter">æ¸…é™¤ç­›é€‰</cover-view>
            <cover-view class="filter-confirm" bindtap="toggleStatusFilter">ç¡®å®š</cover-view>
          </cover-view>
        </cover-view>

      </map>
    </view>

    <view class="bottom-sheet {{dragging ? 'dragging' : ''}}" style="height: {{sheetHeight}}px; padding-bottom: {{safeBottom}}px;">
    <view
      class="sheet-handle"
      bindtap="onSheetHandleTap"
      catchtouchstart="onSheetTouchStart"
      catchtouchmove="onSheetTouchMove"
      catchtouchend="onSheetTouchEnd"
      catchtouchcancel="onSheetTouchEnd"
    >
        <view class="sheet-handle-bar"></view>
      </view>

      <scroll-view scroll-x class="category-scroll" enable-flex>
        <view
          class="category-item {{currentCategoryId === item.id ? 'active' : ''}}"
          wx:for="{{categories}}"
          wx:key="id"
          bindtap="onCategoryTap"
          data-id="{{item.id}}"
        >
          <image class="cat-icon" src="{{item.icon}}" mode="aspectFit" />
          <text class="cat-name">{{item.shortName}}</text>
        </view>
      </scroll-view>

      <scroll-view scroll-x class="filter-scroll" enable-flex wx:if="{{sheetMode !== 'collapsed'}}">
        <view
          class="filter-item {{currentChipId === item.id ? 'active' : ''}}"
          wx:for="{{chips}}"
          wx:key="id"
          bindtap="onChipTap"
          data-id="{{item.id}}"
        >
          {{item.name}}
        </view>
      </scroll-view>

      <view class="sheet-content" wx:if="{{sheetMode !== 'collapsed'}}">
        <scroll-view scroll-y class="facility-list">
          <view class="facility-card" wx:for="{{facilities}}" wx:key="id" bindtap="onFacilityTap" data-id="{{item.id}}">
            <view class="card-header">
              <view class="header-left">
                <image class="header-icon" src="{{item.icon}}" mode="aspectFit" />
                <text class="tag">{{item.categoryName}}</text>
              </view>
              <text class="distance">{{item.distanceText}}</text>
            </view>
            <view class="place-name">{{item.name}}</view>
            <view class="card-actions">
              <view class="btn-detail" catchtap="onFacilityTap" data-id="{{item.id}}">
                <image class="btn-icon-small" src="/images/icon_list.png" />
                <text>æŸ¥çœ‹è¯¦æƒ…</text>
              </view>
              <view class="btn-route" catchtap="planRouteToFacility" data-id="{{item.id}}">
                <image class="btn-icon-small" src="/images/icon_nav.png" />
                <text>è·¯çº¿</text>
              </view>
              <view class="btn-go" catchtap="onGoTap" data-id="{{item.id}}">
                <image class="btn-icon-small" src="/images/icon_nav.png" />
                <text>å»è¿™é‡Œ</text>
              </view>
            </view>
          </view>

          <view class="empty" wx:if="{{!loading && facilities.length === 0}}">å½“å‰æ¡ä»¶ä¸‹æš‚æ— ç»“æœ</view>
          <view class="loading" wx:if="{{loading}}">åŠ è½½ä¸­...</view>
        </scroll-view>
      </view>
  </view>

  </view>

  <view class="search-overlay" wx:if="{{searchVisible}}">
    <view class="search-mask" bindtap="onSearchClose"></view>
    <view class="search-panel">
      <view class="search-input-row">
        <image class="search-icon" src="/images/search.png" />
        <input class="search-input" placeholder="è¾“å…¥ä½ æƒ³å»çš„åœ°ç‚¹" value="{{searchKeyword}}" bindinput="onSearchInput" focus />
        <view class="search-cancel" bindtap="onSearchClose">å–æ¶ˆ</view>
      </view>
      <scroll-view scroll-y class="search-result-list">
        <view class="search-result" wx:for="{{searchResults}}" wx:key="id" bindtap="onSearchSelect" data-id="{{item.id}}">
          <text class="search-title">{{item.title}}</text>
          <text class="search-sub">{{item.address}}</text>
        </view>
        <view class="empty" wx:if="{{!searchLoading && searchKeyword && searchResults.length === 0}}">æš‚æ— ç»“æœ</view>
        <view class="loading" wx:if="{{searchLoading}}">æœç´¢ä¸­...</view>
      </scroll-view>
    </view>
  </view>
</view>
