<view class="issue-edit-container">
  <view class="header">
    <view class="back-btn" bindtap="handleCancel" aria-role="button" aria-label="返回">
      <image class="back-icon" src="/images/arrow-right-yellow.png" style="transform: rotate(180deg);"></image>
    </view>
    <text class="title">新建位置</text>
    <view class="header-right"></view>
  </view>

  <view class="section">
    <text class="section-title">问题说明</text>
    <textarea
      class="description-input"
      placeholder="请描述问题现状..."
      value="{{description}}"
      maxlength="500"
      show-confirm-bar="false"
      bindinput="onDescriptionInput"
      aria-label="问题说明"
    ></textarea>
    <view class="input-footer">
      <view class="word-count">{{description.length}}/500</view>
      <view 
        class="voice-btn {{isRecording ? 'recording' : ''}}"
        catchtouchstart="streamRecord"
        catchtouchend="endStreamRecord"
        aria-role="button"
        aria-label="{{isRecording ? '正在录音，松开结束' : '按住说话'}}"
      >
        <text class="voice-icon">{{isRecording ? '🎤' : '🎙️'}}</text>
        <text class="voice-text">{{isRecording ? '录音中' : '按住说话'}}</text>
      </view>
    </view>
  </view>

  <view class="section">
    <text class="section-title">我的建议 (选填)</text>
    <textarea
      class="suggestion-input"
      placeholder="您觉得应该如何改进？例如：我觉得这里应该加个坡道..."
      value="{{userSuggestion}}"
      maxlength="500"
      show-confirm-bar="false"
      bindinput="onSuggestionInput"
      aria-label="我的建议"
    ></textarea>
    <view class="word-count">{{userSuggestion.length}}/500</view>
  </view>

  <view class="section">
    <view class="section-header">
      <text class="section-title">现场照片</text>
      <text class="section-subtitle">{{images.length}}/9</text>
    </view>
    <view class="image-list">
      <view
        class="image-item"
        wx:for="{{images}}"
        wx:key="index"
        aria-role="button"
        aria-label="图片{{index + 1}}"
      >
        <image
          class="uploaded-image"
          src="{{item.path}}"
          mode="aspectFill"
          bindtap="previewImage"
          data-src="{{item.path}}"
        ></image>
        <view class="remove-btn" bindtap="removeImage" data-index="{{index}}" aria-role="button" aria-label="删除图片">
          <text class="remove-icon" aria-hidden="true">×</text>
        </view>
      </view>
      <view class="add-image-btn" wx:if="{{images.length < 9}}" bindtap="chooseImage" aria-role="button" aria-label="添加图片">
        <image class="add-icon" src="/images/add-image.png" aria-hidden="true"></image>
        <text class="add-text">继续添加</text>
      </view>
    </view>
  </view>

  <view class="section">
    <text class="section-title">请选择分类</text>
    <text class="category-required">*</text>
    <view class="category-grid">
      <view
        class="category-item {{selectedCategory === item.name ? 'active' : ''}}"
        wx:for="{{categoryOptions}}"
        wx:key="id"
        data-category="{{item.name}}"
        data-id="{{item.id}}"
        bindtap="onCategorySelect"
        aria-role="button"
        aria-label="{{item.name}}"
      >
        <text class="category-text">{{item.name}}</text>
      </view>
    </view>
  </view>

  <view class="section">
    <text class="section-title">联系方式（选填）：</text>
    <input
      class="contact-input"
      placeholder="该设施联系方式（如有人想咨询可以拨打）"
      value="{{contactPhone}}"
      bindinput="onContactPhoneInput"
      bindblur="onContactPhoneBlur"
      type="text"
      aria-label="联系电话"
    />
    <text class="contact-hint">* 填写后他人可一键拨打联系您，非必填</text>
  </view>

  <view class="section">
    <view class="section-header">
      <text class="section-title">位置信息</text>
      <view class="reselect-btn" bindtap="chooseLocation" aria-role="button" aria-label="重新定位">
        <text>重新选点</text>
      </view>
    </view>
    <text class="location-text">{{formattedAddress || address || '暂未选择位置'}}</text>
    <input
      class="detail-address-input"
      placeholder="请输入详细地址与门牌号（如：3号楼2单元101室）"
      value="{{detailAddress}}"
      bindinput="onDetailAddressInput"
      type="text"
      aria-label="详细地址与门牌号"
    />
  </view>

  <view class="section">
    <view class="section-header">
      <text class="section-title">🤖 AI 生成材料报告 (可编辑)</text>
      <text class="label-hint">点击下方可修改</text>
      <view class="ai-btn" bindtap="generateAISolution" aria-role="button" aria-label="生成材料报告">
        <text>{{aiSolution ? '重新生成' : '生成报告'}}</text>
      </view>
    </view>
    <view class="ai-content">
        <textarea
          class="ai-textarea"
          auto-height
          maxlength="1000"
          placeholder="AI 正在分析中..."
          value="{{aiSolution}}"
          bindinput="onAiSolutionInput"
          aria-label="AI生成材料报告"
        ></textarea>
      </view>
  </view>

  <view class="footer-actions">
    <button class="submit-btn" bindtap="submitIssue" aria-label="发布到社区">
      发布到社区
    </button>
  </view>

  <view class="loading-mask" wx:if="{{generatingAI || submitting}}">
    <view class="loading-content">
      <image class="loading-icon" src="/images/loading.gif" aria-hidden="true"></image>
      <text class="loading-text">{{generatingAI ? 'AI 生成中...' : '提交中...'}} </text>
    </view>
  </view>
</view>
