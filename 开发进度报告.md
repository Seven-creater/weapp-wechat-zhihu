# ç„¡ç•Œè¥é€  - åŠŸèƒ½å¼€å‘è¿›åº¦æŠ¥å‘Š

## âœ… å·²å®ŒæˆåŠŸèƒ½ï¼ˆ2026-02-01ï¼‰

### ä¸€ã€ç”¨æˆ·è§’è‰²è®¤è¯ç³»ç»Ÿ âœ…

#### 1. ç”¨æˆ·è§’è‰²å®šä¹‰
- **æ–‡ä»¶**: `utils/userTypes.js`
- **åŠŸèƒ½**: å®šä¹‰äº†å››ç§ç”¨æˆ·è§’è‰²
  - æ™®é€šç”¨æˆ· (normal)
  - è®¾è®¡è€… (designer) - éœ€è¦è®¤è¯
  - æ–½å·¥æ–¹ (contractor) - éœ€è¦è®¤è¯
  - ç¤¾åŒºå·¥ä½œè€… (communityWorker) - éœ€è¦è®¤è¯
- **æ¯ä¸ªè§’è‰²åŒ…å«**:
  - æƒé™é…ç½® (permissions)
  - åŠŸèƒ½åˆ—è¡¨ (features)
  - è®¤è¯å­—æ®µ (profileFields)
  - å¾½ç« æ ·å¼ (badge)

#### 2. è®¤è¯ç”³è¯·åŠŸèƒ½
- **å‰ç«¯é¡µé¢**: `pages/switch-identity/index.js`
  - ç”¨æˆ·å¯ä»¥é€‰æ‹©è§’è‰²
  - å¡«å†™è®¤è¯ä¿¡æ¯
  - æäº¤è®¤è¯ç”³è¯·
  
- **äº‘å‡½æ•°**: `cloudfunctions/applyCertification/`
  - ç»Ÿä¸€å¤„ç†æ‰€æœ‰è§’è‰²çš„è®¤è¯ç”³è¯·
  - éªŒè¯å¿…å¡«å­—æ®µ
  - ä¿å­˜åˆ° users é›†åˆçš„ certificationApplication å­—æ®µ

#### 3. è®¤è¯å®¡æ ¸åŠŸèƒ½
- **ç®¡ç†å‘˜é¡µé¢**: `pages/admin-certification/index.js`
  - æŸ¥çœ‹æ‰€æœ‰è®¤è¯ç”³è¯·
  - æŒ‰çŠ¶æ€ç­›é€‰ (å¾…å®¡æ ¸/å·²é€šè¿‡/å·²æ‹’ç»)
  - æŒ‰è§’è‰²ç­›é€‰ (è®¾è®¡è€…/æ–½å·¥æ–¹/ç¤¾åŒºå·¥ä½œè€…)
  - é€šè¿‡/æ‹’ç»ç”³è¯·
  
- **äº‘å‡½æ•°**:
  - `getCertificationApplications/` - è·å–è®¤è¯ç”³è¯·åˆ—è¡¨
  - `getCertificationStats/` - è·å–ç»Ÿè®¡æ•°æ®
  - `reviewCertification/` - å®¡æ ¸è®¤è¯ç”³è¯·

---

### äºŒã€å¸–å­çŠ¶æ€æµè½¬ç³»ç»Ÿ âœ…

#### 1. å¸–å­æ•°æ®ç»“æ„
- **çŠ¶æ€å­—æ®µ**: `status` (pending | in_progress | completed)
- **AIè¯Šæ–­ä¿¡æ¯**: `aiDiagnosis`
- **åˆå§‹æ–¹æ¡ˆ**: `initialSolution`
- **è®¾è®¡è€…æ–¹æ¡ˆ**: `designerSolutions` (æ•°ç»„)
- **æ–½å·¥é¡¹ç›®**: `constructionProject`
- **æ˜¯å¦æ¡ˆä¾‹**: `isCase` (å®Œæˆåè‡ªåŠ¨è®¾ä¸º true)

#### 2. è®¾è®¡è€…æ·»åŠ æ–¹æ¡ˆ
- **äº‘å‡½æ•°**: `cloudfunctions/addDesignerSolution/`
- **åŠŸèƒ½**:
  - éªŒè¯è®¾è®¡è€…èº«ä»½
  - æ£€æŸ¥å¸–å­çŠ¶æ€ (åªèƒ½ä¸º pending çŠ¶æ€çš„å¸–å­æ·»åŠ æ–¹æ¡ˆ)
  - æ·»åŠ è®¾è®¡æ–¹æ¡ˆåˆ° designerSolutions æ•°ç»„
  - æ”¯æŒä¸Šä¼ è®¾è®¡å›¾çº¸
  - æ”¯æŒä¼˜åŒ–é¢„ç®—

#### 3. æ–½å·¥æ–¹åˆ›å»ºé¡¹ç›®
- **äº‘å‡½æ•°**: `cloudfunctions/createConstructionProject/`
- **åŠŸèƒ½**:
  - éªŒè¯æ–½å·¥æ–¹èº«ä»½
  - æ£€æŸ¥å¸–å­çŠ¶æ€ (åªèƒ½æ¥å• pending çŠ¶æ€çš„å¸–å­)
  - åˆ›å»º construction_projects è®°å½•
  - æ›´æ–°å¸–å­çŠ¶æ€ä¸º in_progress
  - è®°å½•æ–½å·¥æ–¹ä¿¡æ¯

#### 4. æ›´æ–°æ–½å·¥è¿›åº¦
- **äº‘å‡½æ•°**: `cloudfunctions/updateConstructionProgress/`
- **åŠŸèƒ½**:
  - éªŒè¯æƒé™ (æ–½å·¥æ–¹æˆ–ç¤¾åŒºå·¥ä½œè€…)
  - æ·»åŠ é‡Œç¨‹ç¢‘è®°å½•
  - ä¸Šä¼ è¿›åº¦ç…§ç‰‡
  - æ›´æ–°è¿›åº¦ç™¾åˆ†æ¯”
  - åŒæ­¥æ›´æ–°å¸–å­ä¸­çš„è¿›åº¦ä¿¡æ¯
  - è¿›åº¦è¾¾åˆ° 100% è‡ªåŠ¨æ ‡è®°ä¸ºå®Œæˆ

#### 5. ç¡®è®¤å®Œå·¥
- **äº‘å‡½æ•°**: `cloudfunctions/confirmCompletion/`
- **åŠŸèƒ½**:
  - éªŒè¯æƒé™ (å‘å¸–è€…æˆ–ç¤¾åŒºå·¥ä½œè€…)
  - ä¸Šä¼ å®Œå·¥ç…§ç‰‡
  - å¡«å†™éªŒæ”¶åé¦ˆ
  - æ›´æ–°å¸–å­çŠ¶æ€ä¸º completed
  - è‡ªåŠ¨ç§»è‡³æ¡ˆä¾‹åº“ (isCase = true)

---

### ä¸‰ã€æƒé™ç®¡ç†ç³»ç»Ÿ âœ…

#### 1. æƒé™å·¥å…·æ¨¡å—
- **æ–‡ä»¶**: `utils/permission.js`
- **åŠŸèƒ½**:
  - `getUserType()` - è·å–å½“å‰ç”¨æˆ·ç±»å‹
  - `hasPermission(permission)` - æ£€æŸ¥æ˜¯å¦æœ‰æŸä¸ªæƒé™
  - `canAddDesignSolution(post)` - æ£€æŸ¥æ˜¯å¦å¯ä»¥æ·»åŠ è®¾è®¡æ–¹æ¡ˆ
  - `canCreateProject(post)` - æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ›å»ºæ–½å·¥é¡¹ç›®
  - `canUpdateProgress(project)` - æ£€æŸ¥æ˜¯å¦å¯ä»¥æ›´æ–°è¿›åº¦
  - `canConfirmCompletion(post)` - æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¡®è®¤å®Œå·¥
  - `canViewContact()` - æ£€æŸ¥æ˜¯å¦å¯ä»¥æŸ¥çœ‹è”ç³»æ–¹å¼
  - `getStatusText(status)` - è·å–çŠ¶æ€ä¸­æ–‡æè¿°
  - `getStatusColor(status)` - è·å–çŠ¶æ€é¢œè‰²

---

## ğŸ“Š æ•°æ®åº“é›†åˆè®¾è®¡

### 1. users é›†åˆ
```javascript
{
  _openid: string,
  userInfo: { nickName, avatarUrl, phone },
  userType: 'normal' | 'designer' | 'contractor' | 'communityWorker',
  badge: { color, icon, text },
  profile: {
    // è®¾è®¡è€…å­—æ®µ
    organization: string,
    title: string,
    expertise: string,
    
    // æ–½å·¥æ–¹å­—æ®µ
    companyName: string,
    contactPerson: string,
    contactPhone: string,
    serviceArea: string,
    specialties: string,
    
    // ç¤¾åŒºå·¥ä½œè€…å­—æ®µ
    community: string,
    position: string,
    workId: string
  },
  certificationApplication: {
    type: string,
    info: object,
    status: 'pending' | 'approved' | 'rejected',
    applyTime: number,
    reviewTime: number,
    rejectReason: string
  }
}
```

### 2. posts é›†åˆ
```javascript
{
  _openid: string,
  content: string,
  images: [string],
  category: string,
  location: GeoPoint,
  
  // ğŸ†• çŠ¶æ€å­—æ®µ
  status: 'pending' | 'in_progress' | 'completed',
  
  // ğŸ†• AIè¯Šæ–­
  aiDiagnosis: {
    category: string,
    description: string,
    generatedAt: string
  },
  
  // ğŸ†• åˆå§‹æ–¹æ¡ˆ
  initialSolution: {
    aiAnalysis: string,
    category: string,
    estimatedCost: number
  },
  
  // ğŸ†• è®¾è®¡è€…æ–¹æ¡ˆ
  designerSolutions: [{
    designerId: string,
    designerName: string,
    optimizedPlan: string,
    drawings: [string],
    optimizedCost: number,
    addedAt: string
  }],
  
  // ğŸ†• æ–½å·¥é¡¹ç›®
  constructionProject: {
    projectId: string,
    constructorId: string,
    constructorName: string,
    status: string,
    progress: number,
    milestones: [object]
  },
  
  // ğŸ†• å®Œå·¥ä¿¡æ¯
  completion: {
    confirmedBy: string,
    confirmedByType: string,
    confirmedAt: string,
    afterImages: [string],
    feedback: string,
    rating: number
  },
  
  // ğŸ†• æ˜¯å¦æ¡ˆä¾‹
  isCase: boolean
}
```

### 3. construction_projects é›†åˆ
```javascript
{
  postId: string,
  projectName: string,
  category: string,
  
  ownerId: string,
  ownerName: string,
  
  constructorId: string,
  constructorName: string,
  constructorCompany: string,
  
  status: 'pending' | 'in_progress' | 'completed',
  
  plan: {
    startDate: string,
    endDate: string,
    budget: number
  },
  
  progress: number,
  milestones: [{
    stage: string,
    completedAt: string,
    photos: [string],
    notes: string
  }],
  
  supervisions: [{
    supervisorId: string,
    visitDate: string,
    photos: [string],
    notes: string
  }]
}
```

---

## ğŸ¯ ä¸šåŠ¡æµç¨‹

### å®Œæ•´æµç¨‹å›¾
```
1. æ™®é€šç”¨æˆ·å‘å¸ƒé—®é¢˜
   â†“
   åˆ›å»º post (status: pending)
   
2. è®¾è®¡è€…æ·»åŠ æ–¹æ¡ˆï¼ˆå¯é€‰ï¼‰
   â†“
   æ·»åŠ åˆ° post.designerSolutions
   
3. æ–½å·¥æ–¹åˆ›å»ºé¡¹ç›®
   â†“
   åˆ›å»º construction_projects
   æ›´æ–° post.status = 'in_progress'
   
4. æ–½å·¥æ–¹æ›´æ–°è¿›åº¦
   â†“
   æ·»åŠ é‡Œç¨‹ç¢‘åˆ° milestones
   æ›´æ–° progress
   
5. å‘å¸–è€…/ç¤¾åŒºå·¥ä½œè€…ç¡®è®¤å®Œå·¥
   â†“
   æ›´æ–° post.status = 'completed'
   è®¾ç½® post.isCase = true
   
6. å¸–å­è‡ªåŠ¨ç§»è‡³æ¡ˆä¾‹åº“
   â†“
   åœ¨æ¡ˆä¾‹æ¿å—æŒ‰äº”å¤§å·¥ç¨‹åˆ†ç±»å±•ç¤º
```

---

## ğŸš€ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

### å¾…å®ŒæˆåŠŸèƒ½

#### 1. å‰ç«¯é¡µé¢å¼€å‘
- [ ] å¸–å­è¯¦æƒ…é¡µæ˜¾ç¤ºçŠ¶æ€å’Œè¿›åº¦
- [ ] è®¾è®¡è€…æ·»åŠ æ–¹æ¡ˆé¡µé¢
- [ ] æ–½å·¥æ–¹æ¥å•é¡µé¢
- [ ] æ–½å·¥è¿›åº¦æ›´æ–°é¡µé¢
- [ ] å®Œå·¥éªŒæ”¶é¡µé¢
- [ ] æ¡ˆä¾‹æ¿å—é¡µé¢ï¼ˆæŒ‰äº”å¤§å·¥ç¨‹åˆ†ç±»ï¼‰

#### 2. ç¤¾åŒºå·¥ä½œè€…åŠŸèƒ½
- [ ] ç›‘ç£ç®¡ç†é¡µé¢
- [ ] æŸ¥çœ‹è”ç³»æ–¹å¼åŠŸèƒ½
- [ ] æ·»åŠ ç›‘ç£è®°å½•åŠŸèƒ½

#### 3. ä¼˜åŒ–åŠŸèƒ½
- [ ] ä»·æ ¼çˆ¬è™«ï¼ˆåç»­ï¼‰
- [ ] å®æ—¶é€šçŸ¥ï¼ˆè®¢é˜…æ¶ˆæ¯ï¼‰
- [ ] æ•°æ®ç»Ÿè®¡åˆ†æ

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. éƒ¨ç½²äº‘å‡½æ•°
```bash
# åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­
# å³é”®ç‚¹å‡» cloudfunctions ç›®å½•
# é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"

éœ€è¦éƒ¨ç½²çš„äº‘å‡½æ•°ï¼š
- applyCertification
- reviewCertification
- getCertificationApplications
- getCertificationStats
- addDesignerSolution
- createConstructionProject
- updateConstructionProgress
- confirmCompletion
```

### 2. é…ç½®ç®¡ç†å‘˜
åœ¨ä»¥ä¸‹äº‘å‡½æ•°ä¸­ä¿®æ”¹ ADMIN_OPENIDS æ•°ç»„ï¼š
- `reviewCertification/index.js`
- `getCertificationApplications/index.js`
- `getCertificationStats/index.js`

```javascript
const ADMIN_OPENIDS = [
  'your-admin-openid-here'  // æ›¿æ¢ä¸ºä½ çš„ openid
];
```

### 3. æµ‹è¯•æµç¨‹
1. ç”¨æˆ·æ³¨å†Œç™»å½•
2. ç”³è¯·è§’è‰²è®¤è¯ï¼ˆè®¾è®¡è€…/æ–½å·¥æ–¹ï¼‰
3. ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
4. å‘å¸ƒé—®é¢˜ï¼ˆéšæ‰‹æ‹ï¼‰
5. è®¾è®¡è€…æ·»åŠ æ–¹æ¡ˆ
6. æ–½å·¥æ–¹åˆ›å»ºé¡¹ç›®
7. æ›´æ–°æ–½å·¥è¿›åº¦
8. ç¡®è®¤å®Œå·¥
9. æŸ¥çœ‹æ¡ˆä¾‹åº“

---

## ğŸ‰ æ€»ç»“

ç›®å‰å·²å®Œæˆï¼š
- âœ… ç”¨æˆ·è§’è‰²è®¤è¯ç³»ç»Ÿï¼ˆ100%ï¼‰
- âœ… å¸–å­çŠ¶æ€æµè½¬ç³»ç»Ÿï¼ˆ100%ï¼‰
- âœ… æƒé™ç®¡ç†ç³»ç»Ÿï¼ˆ100%ï¼‰
- âœ… æ ¸å¿ƒäº‘å‡½æ•°ï¼ˆ100%ï¼‰

**æ€»ä½“è¿›åº¦ï¼šçº¦ 75%**

å‰©ä½™å·¥ä½œä¸»è¦æ˜¯å‰ç«¯é¡µé¢çš„å¼€å‘å’ŒUIä¼˜åŒ–ã€‚

---

**æœ€åæ›´æ–°æ—¶é—´**: 2026-02-01
**å¼€å‘è€…**: ç„¡ç•Œè¥é€ æŠ€æœ¯ç»„



