# 無界营造 - 页面迁移指南

## 📋 迁移说明

本指南帮助你将现有页面代码逐步迁移到新的工具函数和模块，提升代码质量和可维护性。

---

## 🎯 迁移原则

1. **渐进式迁移**：不要一次性修改所有页面，逐个页面迁移
2. **保持功能不变**：迁移后功能必须与原来完全一致
3. **充分测试**：每迁移一个页面，都要进行完整测试
4. **保留备份**：迁移前备份原始代码

---

## 📊 迁移优先级

### 高优先级（建议先迁移）
1. ✅ 登录相关页面（pages/mine/index.js）
2. ✅ 发布相关页面（pages/issue-edit/index.js, pages/post/new-post/index.js）
3. ✅ 地图相关页面（pages/index/index.js, pages/map-view/index.js）

### 中优先级
4. ⏳ 详情页面（pages/post-detail/index.js, pages/solution-detail/index.js）
5. ⏳ 列表页面（pages/community/community.js, pages/solutions/index.js）

### 低优先级
6. ⏳ 其他辅助页面

---

## 🔧 迁移步骤

### 步骤 1：引入新模块

在页面 JS 文件顶部添加：

```javascript
// 原有代码
const app = getApp();
const db = wx.cloud.database();

// 新增：引入工具模块
const { showLoading, hideLoading, showSuccess, showError, confirm } = require('../../utils/common.js');
const permission = require('../../utils/permission.js');
const storage = require('../../utils/storage.js');
const database = require('../../utils/database.js');
const content = require('../../utils/content.js');
const ai = require('../../utils/ai.js');
const map = require('../../utils/map.js');
```

### 步骤 2：替换加载提示

**原代码**：
```javascript
wx.showLoading({ title: '加载中...', mask: true });
// ... 操作
wx.hideLoading();
```

**新代码**：
```javascript
showLoading('加载中...');
// ... 操作
hideLoading();
```

### 步骤 3：替换错误提示

**原代码**：
```javascript
wx.showToast({ title: '操作失败', icon: 'none' });
```

**新代码**：
```javascript
showError('操作失败');
```

### 步骤 4：替换成功提示

**原代码**：
```javascript
wx.showToast({ title: '操作成功', icon: 'success' });
```

**新代码**：
```javascript
showSuccess('操作成功');
```

### 步骤 5：替换确认对话框

**原代码**：
```javascript
wx.showModal({
  title: '提示',
  content: '确定要删除吗？',
  success: (res) => {
    if (res.confirm) {
      // 确认操作
    }
  }
});
```

**新代码**：
```javascript
confirm('确定要删除吗？', '提示')
  .then(confirmed => {
    if (confirmed) {
      // 确认操作
    }
  });
```

### 步骤 6：替换权限请求

**原代码**：
```javascript
wx.authorize({
  scope: 'scope.userLocation',
  success: () => {
    // 有权限
  },
  fail: () => {
    // 无权限
  }
});
```

**新代码**：
```javascript
permission.requestLocationPermission()
  .then(hasPermission => {
    if (hasPermission) {
      // 有权限
    }
  });
```

### 步骤 7：替换数据存储

**原代码**：
```javascript
wx.setStorageSync('userInfo', userInfo);
const userInfo = wx.getStorageSync('userInfo');
```

**新代码**：
```javascript
storage.setUserInfo(userInfo);
const userInfo = storage.getUserInfo();
```

### 步骤 8：替换内容安全检测

**原代码**：
```javascript
wx.cloud.callFunction({
  name: 'checkContent',
  data: { type: 'text', value: text },
  success: (res) => {
    if (res.result.code === 0) {
      // 安全
    }
  }
});
```

**新代码**：
```javascript
content.checkTextSafe(text)
  .then(() => {
    // 安全
  })
  .catch(err => {
    showError(err.message);
  });
```

### 步骤 9：替换数据库操作

**原代码**：
```javascript
db.collection('posts').add({
  data: {
    ...postData,
    createTime: db.serverDate()
  }
}).then(res => {
  // 成功
});
```

**新代码**：
```javascript
database.savePost(postData)
  .then(res => {
    // 成功
  });
```

### 步骤 10：替换地图操作

**原代码**：
```javascript
const qqmapsdk = new QQMapWX({ key: 'YOUR_KEY' });
qqmapsdk.search({
  keyword: '无障碍设施',
  success: (res) => {
    // 处理结果
  }
});
```

**新代码**：
```javascript
map.searchPlace({
  keyword: '无障碍设施',
  location: { latitude: 23.1, longitude: 113.3 }
})
.then(places => {
  // 处理结果
});
```

---

## 📝 完整迁移示例

### 示例：迁移发布页面（pages/post/new-post/index.js）

#### 原代码片段：
```javascript
submitPost: function() {
  const content = this.data.content.trim();
  
  if (!content) {
    wx.showToast({ title: '请输入内容', icon: 'none' });
    return;
  }
  
  wx.showLoading({ title: '发布中...', mask: true });
  
  // 内容安全检测
  wx.cloud.callFunction({
    name: 'checkContent',
    data: { type: 'text', value: content }
  })
  .then(res => {
    if (res.result.code !== 0) {
      throw new Error('内容包含敏感信息');
    }
    
    // 上传图片
    return this.uploadImages();
  })
  .then(fileIDs => {
    // 保存到数据库
    return db.collection('posts').add({
      data: {
        content: content,
        images: fileIDs,
        createTime: db.serverDate()
      }
    });
  })
  .then(() => {
    wx.hideLoading();
    wx.showToast({ title: '发布成功', icon: 'success' });
    wx.navigateBack();
  })
  .catch(err => {
    wx.hideLoading();
    wx.showToast({ title: err.message || '发布失败', icon: 'none' });
  });
}
```

#### 迁移后代码：
```javascript
// 页面顶部引入
const { showLoading, hideLoading, showSuccess, showError } = require('../../utils/common.js');
const content = require('../../utils/content.js');
const database = require('../../utils/database.js');

submitPost: function() {
  const postContent = this.data.content.trim();
  
  if (!postContent) {
    showError('请输入内容');
    return;
  }
  
  showLoading('发布中...');
  
  // 内容安全检测
  content.checkTextSafe(postContent)
    .then(() => {
      // 上传图片
      return this.uploadImages();
    })
    .then(fileIDs => {
      // 保存到数据库
      return database.savePost({
        content: postContent,
        images: fileIDs,
      });
    })
    .then(() => {
      hideLoading();
      showSuccess('发布成功');
      wx.navigateBack();
    })
    .catch(err => {
      hideLoading();
      showError(err.message || '发布失败');
    });
}
```

**优势**：
- ✅ 代码更简洁
- ✅ 错误处理统一
- ✅ 易于维护
- ✅ 功能完全一致

---

## 🧪 迁移测试清单

每迁移一个页面后，必须测试以下内容：

### 基础功能测试
- [ ] 页面能正常打开
- [ ] 数据能正常加载
- [ ] 交互功能正常
- [ ] 跳转功能正常

### 权限测试
- [ ] 位置权限请求正常
- [ ] 相机权限请求正常
- [ ] 相册权限请求正常
- [ ] 录音权限请求正常

### 数据测试
- [ ] 数据能正常保存
- [ ] 数据能正常读取
- [ ] 数据能正常更新
- [ ] 数据能正常删除

### 错误处理测试
- [ ] 网络错误提示正常
- [ ] 权限拒绝提示正常
- [ ] 内容违规提示正常
- [ ] 其他错误提示正常

### 性能测试
- [ ] 加载速度正常
- [ ] 无明显卡顿
- [ ] 内存占用正常

---

## ⚠️ 常见问题

### 问题 1：引入模块后报错
**原因**：路径不正确

**解决**：检查相对路径，确保正确
```javascript
// 正确（pages/xxx/xxx.js）
require('../../utils/common.js')

// 错误
require('../utils/common.js')
```

### 问题 2：工具函数不生效
**原因**：未正确调用

**解决**：检查函数调用方式
```javascript
// 正确
const { showLoading } = require('../../utils/common.js');
showLoading('加载中...');

// 错误
const common = require('../../utils/common.js');
common.showLoading('加载中...'); // 这样也可以，但不推荐
```

### 问题 3：Promise 链式调用报错
**原因**：错误处理不当

**解决**：确保每个 Promise 都有 catch
```javascript
// 正确
promise1()
  .then(() => promise2())
  .then(() => promise3())
  .catch(err => {
    console.error(err);
  });
```

---

## 📊 迁移进度跟踪

### 建议使用表格跟踪迁移进度：

| 页面 | 优先级 | 状态 | 测试 | 备注 |
|------|--------|------|------|------|
| pages/mine/index.js | 高 | ⏳ 待迁移 | ⏳ | 个人中心 |
| pages/issue-edit/index.js | 高 | ⏳ 待迁移 | ⏳ | 随手拍 |
| pages/post/new-post/index.js | 高 | ⏳ 待迁移 | ⏳ | 发布动态 |
| pages/index/index.js | 高 | ⏳ 待迁移 | ⏳ | 地图导航 |
| ... | ... | ... | ... | ... |

---

## 🎯 迁移目标

### 短期目标（1-2周）
- [ ] 迁移 5 个高优先级页面
- [ ] 完成基础功能测试
- [ ] 修复发现的问题

### 中期目标（2-4周）
- [ ] 迁移所有核心页面
- [ ] 完成全功能测试
- [ ] 优化性能

### 长期目标（1-2月）
- [ ] 迁移所有页面
- [ ] 代码质量达标
- [ ] 性能优化完成

---

## 📞 技术支持

如遇到迁移问题，请参考：
- `代码重构完成报告.md` - 重构说明
- `使用手册.md` - 功能使用说明
- 本文档 - 迁移指南

---

**迁移原则**：稳扎稳打，逐步推进，确保质量！

**迁移时间**：建议每天迁移 1-2 个页面，确保充分测试。

**迁移完成标志**：所有页面都使用新的工具函数，代码简洁规范，功能完全正常。









