# 管理员管理操作手册

## 📋 目录
1. [添加新管理员](#添加新管理员)
2. [删除管理员](#删除管理员)
3. [查看所有管理员](#查看所有管理员)
4. [常见问题](#常见问题)

---

## 🆕 添加新管理员

### 方法一：硬编码方式（推荐，最安全）

#### 步骤1：获取新管理员的 openid

让新管理员登录小程序后，在微信开发者工具的**控制台**中运行：

```javascript
const openid = getApp().globalData.openid || wx.getStorageSync('openid');
console.log('我的 openid:', openid);
```

复制显示的 openid（例如：`oOJhu3Qxxxxxxxxxxxxxxxxxxx`）

#### 步骤2：修改云函数代码

需要修改以下**6个云函数**，在每个云函数的 `SUPER_ADMIN_OPENIDS` 数组中添加新的 openid：

1. `cloudfunctions/getCertificationApplications/index.js`
2. `cloudfunctions/reviewCertification/index.js`
3. `cloudfunctions/getCertificationStats/index.js`
4. `cloudfunctions/getCommunityWorkerCertApplications/index.js`
5. `cloudfunctions/reviewCommunityWorkerCertification/index.js`
6. `cloudfunctions/setAdmin/index.js`

**修改示例**：

找到这段代码：
```javascript
// 🔐 超级管理员列表（硬编码）
const SUPER_ADMIN_OPENIDS = [
  'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',
  'oOJhu3T9Us9TAnibhfctmyRw2Urc'
];
```

添加新的 openid：
```javascript
// 🔐 超级管理员列表（硬编码）
const SUPER_ADMIN_OPENIDS = [
  'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',
  'oOJhu3T9Us9TAnibhfctmyRw2Urc',
  'oOJhu3Qxxxxxxxxxxxxxxxxxxx'  // 新管理员的 openid
];
```

#### 步骤3：修改前端代码

修改 `pages/mine/index.js` 文件，找到 `checkIsAdmin` 函数中的 `SUPER_ADMIN_OPENIDS` 数组，同样添加新的 openid：

```javascript
checkIsAdmin: async function(openid) {
  // 🔐 超级管理员列表（硬编码）
  const SUPER_ADMIN_OPENIDS = [
    'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',
    'oOJhu3T9Us9TAnibhfctmyRw2Urc',
    'oOJhu3Qxxxxxxxxxxxxxxxxxxx'  // 新管理员的 openid
  ];
  
  // ... 其他代码
}
```

#### 步骤4：上传云函数

在微信开发者工具中，右键点击以下文件夹 → **"上传并部署：云端安装依赖"**：

- `cloudfunctions/getCertificationApplications`
- `cloudfunctions/reviewCertification`
- `cloudfunctions/getCertificationStats`
- `cloudfunctions/getCommunityWorkerCertApplications`
- `cloudfunctions/reviewCommunityWorkerCertification`
- `cloudfunctions/setAdmin`

#### 步骤5：编译小程序

点击微信开发者工具的"编译"按钮

#### 步骤6：验证

让新管理员登录小程序：
1. 进入"我的"页面
2. 应该能看到"🔐 认证审核"按钮
3. 点击进入，应该能看到待审核的申请

---

### 方法二：数据库方式（动态管理）

这种方式不需要修改代码，但需要先有一个管理员来操作。

#### 步骤1：获取新管理员的 openid

同方法一的步骤1

#### 步骤2：调用 setAdmin 云函数

用现有管理员账号登录，在微信开发者工具的**控制台**中运行：

```javascript
wx.cloud.callFunction({
  name: 'setAdmin',
  data: {
    targetOpenid: 'oOJhu3Qxxxxxxxxxxxxxxxxxxx'  // 新管理员的 openid
  }
}).then(res => {
  console.log('设置管理员成功:', res);
  if (res.result.success) {
    console.log('✅ 已成功添加管理员权限');
  } else {
    console.error('❌ 失败:', res.result.error);
  }
}).catch(err => {
  console.error('❌ 调用失败:', err);
});
```

#### 步骤3：验证

新管理员登录后应该能看到审核功能。

**注意**：
- 这种方式添加的管理员权限存储在数据库中
- 如果数据库被清空，权限会丢失
- 建议重要管理员使用方法一（硬编码）

---

## 🗑️ 删除管理员

### 删除硬编码管理员

#### 步骤1：修改云函数代码

在以下6个云函数中，从 `SUPER_ADMIN_OPENIDS` 数组中删除对应的 openid：

1. `cloudfunctions/getCertificationApplications/index.js`
2. `cloudfunctions/reviewCertification/index.js`
3. `cloudfunctions/getCertificationStats/index.js`
4. `cloudfunctions/getCommunityWorkerCertApplications/index.js`
5. `cloudfunctions/reviewCommunityWorkerCertification/index.js`
6. `cloudfunctions/setAdmin/index.js`

**修改示例**：

删除前：
```javascript
const SUPER_ADMIN_OPENIDS = [
  'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',
  'oOJhu3T9Us9TAnibhfctmyRw2Urc',
  'oOJhu3Qxxxxxxxxxxxxxxxxxxx'  // 要删除的
];
```

删除后：
```javascript
const SUPER_ADMIN_OPENIDS = [
  'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',
  'oOJhu3T9Us9TAnibhfctmyRw2Urc'
];
```

#### 步骤2：修改前端代码

同样在 `pages/mine/index.js` 中删除对应的 openid

#### 步骤3：上传云函数并编译

同添加管理员的步骤4和步骤5

### 删除数据库管理员

#### 方法1：直接修改数据库

1. 打开微信开发者工具
2. 点击"云开发"控制台
3. 进入"数据库" → `users` 集合
4. 找到对应用户的记录
5. 删除或修改以下字段：
   - `isAdmin`: 改为 `false` 或删除
   - `permissions`: 删除或修改权限

#### 方法2：创建云函数（推荐）

创建一个 `removeAdmin` 云函数（可以参考 `setAdmin` 的代码）

---

## 👥 查看所有管理员

### 查看硬编码管理员

直接查看云函数代码中的 `SUPER_ADMIN_OPENIDS` 数组

### 查看数据库管理员

在微信开发者工具的**控制台**中运行：

```javascript
const db = wx.cloud.database();

db.collection('users')
  .where({
    isAdmin: true
  })
  .get()
  .then(res => {
    console.log('数据库中的管理员数量:', res.data.length);
    res.data.forEach((user, index) => {
      console.log(`${index + 1}. ${user.userInfo?.nickName || '未知'}`);
      console.log('   OpenID:', user._openid);
      console.log('   权限:', user.permissions);
    });
  })
  .catch(err => {
    console.error('查询失败:', err);
  });
```

---

## ❓ 常见问题

### Q1: 添加了管理员但看不到审核按钮？

**A:** 检查以下几点：
1. 是否修改了所有6个云函数？
2. 是否重新上传了所有云函数？
3. 是否重新编译了小程序？
4. openid 是否复制正确（注意大小写）？

### Q2: 硬编码和数据库方式有什么区别？

**A:** 
- **硬编码方式**：
  - ✅ 更安全，不会被误删
  - ✅ 权限最高
  - ❌ 需要修改代码并重新上传
  
- **数据库方式**：
  - ✅ 灵活，可以动态添加/删除
  - ✅ 不需要修改代码
  - ❌ 可能被误删
  - ❌ 依赖数据库状态

**建议**：核心管理员使用硬编码，临时管理员使用数据库方式

### Q3: 如何批量添加多个管理员？

**A:** 在 `SUPER_ADMIN_OPENIDS` 数组中一次性添加多个 openid：

```javascript
const SUPER_ADMIN_OPENIDS = [
  'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',
  'oOJhu3T9Us9TAnibhfctmyRw2Urc',
  'oOJhu3Qaaaaaaaaaaaaaaaaaaa',
  'oOJhu3Qbbbbbbbbbbbbbbbbbb',
  'oOJhu3Qcccccccccccccccccc'
];
```

然后按照正常流程上传云函数即可。

### Q4: 管理员权限包括哪些？

**A:** 管理员拥有以下权限：
- ✅ 审核所有类型的认证申请（设计者、施工方、社区工作者）
- ✅ 查看认证统计数据
- ✅ 查看用户联系方式
- ✅ 删除内容（如果实现了相关功能）
- ✅ 管理其他用户（通过 setAdmin 云函数）
- ✅ 系统管理功能

### Q5: 如何临时禁用某个管理员？

**A:** 
- **硬编码管理员**：在 openid 前加 `//` 注释掉，然后重新上传云函数
  ```javascript
  const SUPER_ADMIN_OPENIDS = [
    'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',
    // 'oOJhu3T9Us9TAnibhfctmyRw2Urc',  // 临时禁用
  ];
  ```

- **数据库管理员**：在数据库中将 `isAdmin` 改为 `false`

### Q6: 管理员可以互相删除吗？

**A:** 
- **硬编码管理员**：不能通过云函数删除，只能修改代码
- **数据库管理员**：可以被其他管理员删除（如果实现了 removeAdmin 功能）

---

## 📝 快速参考

### 需要修改的文件清单

添加/删除硬编码管理员时，需要修改以下文件：

**云函数（6个）**：
1. `cloudfunctions/getCertificationApplications/index.js`
2. `cloudfunctions/reviewCertification/index.js`
3. `cloudfunctions/getCertificationStats/index.js`
4. `cloudfunctions/getCommunityWorkerCertApplications/index.js`
5. `cloudfunctions/reviewCommunityWorkerCertification/index.js`
6. `cloudfunctions/setAdmin/index.js`

**前端页面（1个）**：
7. `pages/mine/index.js`

### 修改位置

在每个文件中找到：
```javascript
const SUPER_ADMIN_OPENIDS = [
  // 这里添加或删除 openid
];
```

---

## 🎯 最佳实践

1. **至少保留2个硬编码管理员**，避免单点故障
2. **定期备份管理员列表**，记录所有管理员的 openid
3. **使用有意义的注释**，标注每个管理员的身份
   ```javascript
   const SUPER_ADMIN_OPENIDS = [
     'oOJhu3QmRKlk8Iuu87G6ol0IrDyQ',  // 张三 - 主管理员
     'oOJhu3T9Us9TAnibhfctmyRw2Urc',  // 李四 - 副管理员
   ];
   ```
4. **测试后再上线**，在开发环境测试管理员权限后再发布
5. **记录操作日志**，每次添加/删除管理员都做好记录

---

## 🆘 紧急情况处理

### 所有管理员都无法登录怎么办？

1. 获取任意一个可用账号的 openid
2. 将该 openid 添加到所有云函数的 `SUPER_ADMIN_OPENIDS` 中
3. 重新上传所有云函数
4. 用该账号登录即可恢复管理员权限

### 忘记了管理员的 openid？

在云开发控制台的数据库中查看 `users` 集合，找到对应用户的 `_openid` 字段。

---

## 📞 技术支持

如果遇到问题，请检查：
1. 微信开发者工具的控制台日志
2. 云开发控制台的云函数日志
3. 数据库中的用户记录

---

**文档版本**: v1.0  
**最后更新**: 2026-02-04  
**维护者**: AI Assistant

