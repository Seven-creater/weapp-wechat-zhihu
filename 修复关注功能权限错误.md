# 🔧 修复关注功能权限错误

## 📊 问题描述

**错误信息**：
```
errCode: -502003 database permission denied
Error: Permission denied
```

**原因**：
客户端代码直接调用 `db.collection('follows').where().remove()` 删除关注记录，但数据库权限设置不允许客户端直接删除数据。

---

## ✅ 解决方案

### 1. 创建云函数 `toggleFollow`

**位置**：`cloudfunctions/toggleFollow/`

**功能**：
- ✅ 关注用户
- ✅ 取消关注
- ✅ 自动检查互关状态
- ✅ 自动更新统计数据（关注数、粉丝数）

**使用方法**：
```javascript
wx.cloud.callFunction({
  name: 'toggleFollow',
  data: {
    targetId: '目标用户ID',
    action: 'follow'  // 或 'unfollow'
  }
}).then(res => {
  if (res.result.success) {
    console.log('操作成功');
    console.log('是否互关:', res.result.isMutual);
  }
});
```

### 2. 修改前端代码

**文件**：`pages/user-profile/index.js`

**修改内容**：
- ❌ 删除了客户端直接操作数据库的代码
- ✅ 改用云函数 `toggleFollow` 处理关注/取消关注
- ✅ 简化了代码逻辑
- ✅ 统一了错误处理

---

## 🎯 云函数功能详解

### toggleFollow 云函数

#### 输入参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| targetId | String | ✅ | 目标用户ID |
| action | String | ✅ | 操作类型：'follow' 或 'unfollow' |

#### 返回结果

**成功时**：
```javascript
{
  success: true,
  action: 'follow',  // 或 'unfollow'
  isMutual: true     // 是否互关（仅 follow 时返回）
}
```

**失败时**：
```javascript
{
  success: false,
  error: '错误信息'
}
```

#### 功能特性

**关注用户时**：
1. ✅ 检查是否已经关注
2. ✅ 添加关注记录到 `follows` 集合
3. ✅ 检查是否互关
4. ✅ 如果互关，更新双方的 `isMutual` 字段
5. ✅ 更新当前用户的 `followingCount`（+1）
6. ✅ 更新目标用户的 `followersCount`（+1）

**取消关注时**：
1. ✅ 删除关注记录
2. ✅ 更新对方的 `isMutual` 字段为 false
3. ✅ 更新当前用户的 `followingCount`（-1）
4. ✅ 更新目标用户的 `followersCount`（-1）

---

## 📁 修改的文件

### 新增文件

1. ✅ `cloudfunctions/toggleFollow/index.js` - 云函数主文件
2. ✅ `cloudfunctions/toggleFollow/package.json` - 依赖配置

### 修改文件

1. ✅ `pages/user-profile/index.js` - 用户资料页面

---

## 🚀 部署步骤

### 1. 上传云函数

在微信开发者工具中：
1. 右键点击 `cloudfunctions/toggleFollow/`
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成

### 2. 测试功能

1. 打开小程序
2. 进入其他用户的资料页面
3. 点击"关注"按钮
4. 确认关注成功
5. 再次点击"取消关注"
6. 确认取消成功

---

## ⚠️ 数据库权限配置

确保数据库权限配置正确：

### follows 集合权限

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

**说明**：
- 所有人可以读取关注记录
- 只有记录的创建者可以写入（但删除需要云函数）

### users 集合权限

```json
{
  "read": true,
  "write": false
}
```

**说明**：
- 所有人可以读取用户信息
- 只有云函数可以更新用户统计数据

---

## 🔍 代码对比

### 修改前（客户端直接操作）

```javascript
// ❌ 客户端直接删除 - 会报权限错误
db.collection('follows').where({
  followerId: openid,
  targetId: targetId
}).remove().then(() => {
  // ...
});
```

### 修改后（使用云函数）

```javascript
// ✅ 使用云函数 - 安全可靠
wx.cloud.callFunction({
  name: 'toggleFollow',
  data: {
    targetId: targetId,
    action: 'unfollow'
  }
}).then(res => {
  if (res.result.success) {
    // 操作成功
  }
});
```

---

## 📈 优势

### 安全性
- ✅ 数据操作在云端进行，更安全
- ✅ 防止客户端恶意操作
- ✅ 统一的权限控制

### 可靠性
- ✅ 自动处理互关状态
- ✅ 自动更新统计数据
- ✅ 事务性操作，保证数据一致性

### 可维护性
- ✅ 业务逻辑集中在云函数
- ✅ 前端代码更简洁
- ✅ 易于调试和修改

---

## 🎉 总结

**问题**：客户端直接操作数据库导致权限错误

**解决**：创建云函数处理关注/取消关注操作

**效果**：
- ✅ 修复了权限错误
- ✅ 提升了安全性
- ✅ 简化了前端代码
- ✅ 自动处理互关和统计

---

## 📝 后续建议

### 1. 其他类似功能

如果还有其他地方需要删除数据，也应该使用云函数：
- 删除帖子
- 删除评论
- 删除收藏
- 等等

### 2. 数据库权限

建议统一配置数据库权限：
- **读取**：根据业务需求设置
- **写入**：只允许云函数操作
- **删除**：只允许云函数操作

### 3. 云函数规范

建议所有涉及数据修改的操作都通过云函数：
- ✅ 更安全
- ✅ 更可控
- ✅ 更易维护

---

生成时间：2026-02-01 22:35













