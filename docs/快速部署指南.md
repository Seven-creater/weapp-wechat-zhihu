# 🚀 地图导航模块快速部署指南

## 📋 部署前检查

### 1. 环境要求
- ✅ 微信开发者工具（最新版）
- ✅ 云开发已开通
- ✅ 小程序已配置云开发环境

### 2. 权限配置
确保 `app.json` 中已配置：
```json
{
  "permission": {
    "scope.userLocation": {
      "desc": "我们需要获取您的当前位置，以便自动定位无障碍问题发生的地点"
    }
  },
  "requiredPrivateInfos": ["getLocation", "chooseLocation"]
}
```

---

## 🔧 部署步骤

### 步骤1：部署云函数（4个）

#### 1.1 createFacility
```bash
1. 右键 cloudfunctions/createFacility
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成（约30秒）
```

#### 1.2 updateFacilityStatus
```bash
1. 右键 cloudfunctions/updateFacilityStatus
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成（约30秒）
```

#### 1.3 getFacilities
```bash
1. 右键 cloudfunctions/getFacilities
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成（约30秒）
```

#### 1.4 planAccessibleRoute（新增）
```bash
1. 右键 cloudfunctions/planAccessibleRoute
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成（约30秒）
```

**预计时间：2-3分钟**

---

### 步骤2：创建数据库集合

#### 2.1 创建 facilities 集合
```bash
1. 打开云开发控制台
2. 进入"数据库"
3. 点击"添加集合"
4. 集合名称：facilities
5. 点击"确定"
```

#### 2.2 创建索引
在 facilities 集合中创建以下索引：

**索引1：地理位置索引**
```json
{
  "字段": "location",
  "类型": "2dsphere"
}
```

**索引2：状态索引**
```json
{
  "字段": "status",
  "类型": "ascending"
}
```

**索引3：设施类型索引**
```json
{
  "字段": "facilityType",
  "类型": "ascending"
}
```

**索引4：创建时间索引**
```json
{
  "字段": "createTime",
  "类型": "descending"
}
```

**预计时间：2分钟**

---

### 步骤3：测试云函数

#### 3.1 测试 createFacility
```json
{
  "name": "测试无障碍坡道",
  "facilityType": "无障碍坡道",
  "status": "accessible",
  "latitude": 23.099994,
  "longitude": 113.32452,
  "address": "测试地址",
  "description": "这是一个测试设施",
  "images": []
}
```

#### 3.2 测试 getFacilities
```json
{
  "latitude": 23.099994,
  "longitude": 113.32452,
  "radius": 5000,
  "page": 1,
  "pageSize": 10
}
```

#### 3.3 测试 planAccessibleRoute
```json
{
  "startLat": 23.099994,
  "startLng": 113.32452,
  "endLat": 23.109994,
  "endLng": 113.33452
}
```

**预计时间：3分钟**

---

### 步骤4：编译预览

#### 4.1 编译小程序
```bash
1. 点击"编译"按钮
2. 等待编译完成
3. 检查控制台是否有错误
```

#### 4.2 预览测试
```bash
1. 点击"预览"按钮
2. 扫码在手机上打开
3. 测试以下功能：
   - 地图加载
   - 设施标注
   - 设施详情
   - 路线规划
   - 实时导航
```

**预计时间：5分钟**

---

## ✅ 功能测试清单

### 基础功能测试
- [ ] 地图正常加载
- [ ] 当前位置定位成功
- [ ] 设施标记显示正常

### 设施标注测试
- [ ] 长按地图弹出标注对话框
- [ ] 进入标注页面
- [ ] 选择设施类型
- [ ] 上传照片
- [ ] 提交成功

### 设施详情测试
- [ ] 点击标记进入详情页
- [ ] 信息显示完整
- [ ] 照片预览正常
- [ ] 状态历史显示
- [ ] 更新状态功能（有权限）

### 地图筛选测试
- [ ] 点击筛选按钮
- [ ] 选择状态筛选
- [ ] 地图标记更新
- [ ] 清除筛选

### 路线规划测试
- [ ] 点击"路线"按钮
- [ ] 选择起点终点
- [ ] 规划路线成功
- [ ] 显示多个方案
- [ ] 切换方案
- [ ] 地图显示路线

### 实时导航测试
- [ ] 开始导航
- [ ] 位置实时更新
- [ ] 距离实时计算
- [ ] 语音提示播放
- [ ] 偏离检测
- [ ] 到达提示

---

## 🐛 常见问题

### 问题1：云函数调用失败
**原因**：云函数未部署或部署失败

**解决**：
1. 检查云函数是否部署成功
2. 查看云函数日志
3. 重新部署云函数

---

### 问题2：地理位置查询失败
**原因**：未创建地理位置索引

**解决**：
1. 进入云开发控制台
2. 数据库 → facilities 集合
3. 索引 → 添加索引
4. 字段：location，类型：2dsphere

---

### 问题3：定位失败
**原因**：未授权位置权限

**解决**：
1. 检查 app.json 权限配置
2. 手机设置中开启位置权限
3. 重新打开小程序

---

### 问题4：语音播报不工作
**原因**：未配置语音插件

**解决**：
1. 检查 app.json 中的插件配置：
```json
{
  "plugins": {
    "WeChatSI": {
      "version": "0.3.5",
      "provider": "wx069ba97219f66d99"
    }
  }
}
```
2. 重新编译小程序

---

### 问题5：路线规划返回空
**原因**：附近没有设施数据

**解决**：
1. 先标注一些测试设施
2. 或者使用有设施的区域测试

---

## 📊 性能优化建议

### 1. 云函数优化
- 设置合理的超时时间（建议10秒）
- 使用云函数并发限制
- 定期清理日志

### 2. 数据库优化
- 定期清理过期数据
- 合理设置索引
- 使用分页查询

### 3. 小程序优化
- 图片压缩上传
- 使用缓存机制
- 减少不必要的请求

---

## 🎯 部署检查表

### 云函数部署
- [ ] createFacility 部署成功
- [ ] updateFacilityStatus 部署成功
- [ ] getFacilities 部署成功
- [ ] planAccessibleRoute 部署成功

### 数据库配置
- [ ] facilities 集合已创建
- [ ] 地理位置索引已创建
- [ ] 状态索引已创建
- [ ] 设施类型索引已创建
- [ ] 创建时间索引已创建

### 页面注册
- [ ] pages/facility/mark/index 已注册
- [ ] pages/facility/detail/index 已注册
- [ ] pages/route/plan/index 已注册
- [ ] pages/route/navigate/index 已注册

### 权限配置
- [ ] 位置权限已配置
- [ ] 语音插件已配置
- [ ] 云开发环境已配置

### 功能测试
- [ ] 设施标注功能正常
- [ ] 设施详情功能正常
- [ ] 地图筛选功能正常
- [ ] 路线规划功能正常
- [ ] 实时导航功能正常
- [ ] 语音导航功能正常

---

## 🎉 部署完成

恭喜！地图导航模块已成功部署！

### 下一步：
1. 📱 在真机上测试所有功能
2. 📝 记录测试结果和问题
3. 🐛 修复发现的问题
4. 🚀 准备上线发布

---

**部署时间**：约15分钟  
**难度等级**：⭐⭐⭐☆☆（中等）  
**文档版本**：v1.0  
**更新日期**：2026-02-02

