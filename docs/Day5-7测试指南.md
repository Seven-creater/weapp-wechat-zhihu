# Day 5-7 功能测试指南

## 📋 测试概述

本文档提供 Day 5-7 新增功能的详细测试步骤和预期结果。

---

## 🧪 测试环境准备

### 前置条件：
1. ✅ 已完成 Day 1-4 的所有功能
2. ✅ 云函数已部署（createFacility, updateFacilityStatus, getFacilities）
3. ✅ 数据库已创建 facilities 集合和索引
4. ✅ 已有至少一个测试用户标注的设施

### 测试账号：
- **普通用户**：用于测试基本功能
- **社区工作者**：用于测试管理员功能
- **设施创建者**：用于测试创建者权限

---

## 🎯 测试项目清单

### 一、设施详情页测试

#### 1.1 进入设施详情页
**测试步骤：**
1. 打开小程序，进入地图页面
2. 等待地图加载用户标注的设施
3. 点击地图上的用户标注设施标记（带状态emoji的标记）
4. 观察是否跳转到设施详情页

**预期结果：**
- ✅ 成功跳转到设施详情页
- ✅ 显示加载动画
- ✅ 页面标题显示"设施详情"

---

#### 1.2 设施信息展示
**测试步骤：**
1. 在设施详情页查看头部信息
2. 检查状态徽章颜色和图标
3. 查看设施名称和地址
4. 滚动查看现场照片
5. 查看基本信息区域

**预期结果：**
- ✅ 状态徽章显示正确（颜色和emoji对应）
  - 可通行：绿色 + ✅
  - 障碍点：红色 + 🚫
  - 维修中：黄色 + 🔧
  - 被占用：橙色 + ⚠️
- ✅ 设施名称和地址完整显示
- ✅ 照片以3列网格展示
- ✅ 基本信息包含：类型、状态、描述、创建时间、更新时间

---

#### 1.3 照片预览功能
**测试步骤：**
1. 点击现场照片中的任意一张
2. 观察是否进入照片预览模式
3. 左右滑动切换照片
4. 点击返回退出预览

**预期结果：**
- ✅ 点击照片进入全屏预览
- ✅ 可以左右滑动查看所有照片
- ✅ 显示当前照片序号（如 1/3）
- ✅ 可以正常退出预览

---

#### 1.4 状态历史展示
**测试步骤：**
1. 滚动到状态历史区域
2. 查看时间线展示
3. 检查每条历史记录的信息
4. 点击历史记录中的照片预览

**预期结果：**
- ✅ 时间线从上到下按时间倒序排列
- ✅ 每条记录显示：状态图标、状态名称、更新时间
- ✅ 如有备注，显示备注内容
- ✅ 如有照片，显示照片缩略图
- ✅ 点击历史照片可以预览

---

#### 1.5 导航功能
**测试步骤：**
1. 点击"导航到此"按钮
2. 观察是否调起微信地图导航
3. 检查目标位置是否正确

**预期结果：**
- ✅ 成功调起微信地图
- ✅ 目标位置标记正确
- ✅ 显示设施名称和地址
- ✅ 可以选择导航方式（步行、驾车等）

---

#### 1.6 下拉刷新
**测试步骤：**
1. 在设施详情页下拉
2. 观察刷新动画
3. 等待数据重新加载

**预期结果：**
- ✅ 显示下拉刷新动画
- ✅ 数据重新加载
- ✅ 刷新完成后动画消失

---

### 二、状态更新功能测试

#### 2.1 权限检查（普通用户）
**测试步骤：**
1. 使用普通用户账号登录
2. 进入其他用户创建的设施详情页
3. 查看是否显示"更新状态"按钮

**预期结果：**
- ✅ 不显示"更新状态"按钮
- ✅ 只显示"导航到此"和"举报"按钮

---

#### 2.2 权限检查（创建者）
**测试步骤：**
1. 使用创建者账号登录
2. 进入自己创建的设施详情页
3. 查看是否显示"更新状态"按钮

**预期结果：**
- ✅ 显示"更新状态"按钮
- ✅ 按钮可点击

---

#### 2.3 权限检查（社区工作者）
**测试步骤：**
1. 使用社区工作者账号登录
2. 进入任意设施详情页
3. 查看是否显示"更新状态"按钮

**预期结果：**
- ✅ 显示"更新状态"按钮
- ✅ 按钮可点击

---

#### 2.4 打开更新面板
**测试步骤：**
1. 使用有权限的账号
2. 点击"更新状态"按钮
3. 观察更新面板弹出

**预期结果：**
- ✅ 底部弹出更新面板
- ✅ 显示半透明遮罩
- ✅ 面板从底部滑入动画
- ✅ 当前状态默认选中

---

#### 2.5 选择新状态
**测试步骤：**
1. 在更新面板中点击不同的状态选项
2. 观察选中效果
3. 尝试选择当前状态

**预期结果：**
- ✅ 点击状态后有选中效果（边框和背景色变化）
- ✅ 只能选择一个状态
- ✅ 可以选择当前状态（但提交时会提示）

---

#### 2.6 填写备注
**测试步骤：**
1. 在备注输入框中输入文字
2. 输入超过200字
3. 观察字数限制

**预期结果：**
- ✅ 可以正常输入文字
- ✅ 最多输入200字
- ✅ 超过200字无法继续输入

---

#### 2.7 上传照片
**测试步骤：**
1. 点击"添加照片"按钮
2. 选择相册或拍照
3. 选择多张照片（最多9张）
4. 点击照片右上角的删除按钮

**预期结果：**
- ✅ 可以选择相册或拍照
- ✅ 照片显示在网格中
- ✅ 最多上传9张照片
- ✅ 达到9张后"添加照片"按钮消失
- ✅ 可以删除已选照片

---

#### 2.8 提交状态更新
**测试步骤：**
1. 选择新状态（不同于当前状态）
2. 填写备注（可选）
3. 上传照片（可选）
4. 点击"提交更新"按钮
5. 等待上传完成

**预期结果：**
- ✅ 显示"更新中..."提示
- ✅ 照片上传到云存储
- ✅ 调用云函数更新数据库
- ✅ 显示"更新成功"提示
- ✅ 面板自动关闭
- ✅ 1.5秒后自动刷新详情页
- ✅ 新状态显示在状态历史中

---

#### 2.9 提交失败处理
**测试步骤：**
1. 选择与当前状态相同的状态
2. 点击"提交更新"
3. 观察错误提示

**预期结果：**
- ✅ 显示"状态未改变"提示
- ✅ 不调用云函数
- ✅ 面板不关闭

---

### 三、地图筛选功能测试

#### 3.1 打开筛选面板
**测试步骤：**
1. 在地图页面找到右侧控制按钮
2. 点击"筛选"按钮（🔍图标）
3. 观察筛选面板弹出

**预期结果：**
- ✅ 筛选面板从右侧弹出
- ✅ 显示4个状态选项
- ✅ 显示"清除筛选"和"确定"按钮

---

#### 3.2 单选状态筛选
**测试步骤：**
1. 点击"可通行"选项
2. 点击"确定"按钮
3. 观察地图标记变化
4. 查看筛选按钮徽章

**预期结果：**
- ✅ 选项有选中效果（边框和背景色）
- ✅ 面板关闭
- ✅ 地图只显示"可通行"状态的设施
- ✅ 筛选按钮显示徽章"1"

---

#### 3.3 多选状态筛选
**测试步骤：**
1. 打开筛选面板
2. 选择"可通行"和"障碍点"
3. 点击"确定"
4. 观察地图标记

**预期结果：**
- ✅ 两个选项都有选中效果
- ✅ 地图显示两种状态的设施
- ✅ 筛选按钮显示徽章"2"

---

#### 3.4 清除筛选
**测试步骤：**
1. 在已筛选状态下打开面板
2. 点击"清除筛选"按钮
3. 观察地图标记变化

**预期结果：**
- ✅ 所有选项取消选中
- ✅ 面板关闭
- ✅ 地图显示所有状态的设施
- ✅ 筛选按钮徽章消失

---

#### 3.5 取消筛选操作
**测试步骤：**
1. 打开筛选面板
2. 选择一些状态
3. 点击右上角"✕"关闭按钮
4. 观察地图是否变化

**预期结果：**
- ✅ 面板关闭
- ✅ 地图保持之前的筛选状态
- ✅ 不会应用新选择的状态

---

### 四、长按标注功能测试

#### 4.1 长按地图标注
**测试步骤：**
1. 在地图页面长按任意位置
2. 观察对话框弹出
3. 查看对话框内容

**预期结果：**
- ✅ 弹出确认对话框
- ✅ 标题显示"标注设施"
- ✅ 内容显示"是否在此位置标注无障碍设施？"
- ✅ 显示"标注"和"取消"按钮

---

#### 4.2 确认标注
**测试步骤：**
1. 长按地图
2. 点击"标注"按钮
3. 观察页面跳转

**预期结果：**
- ✅ 跳转到设施标注页面
- ✅ 经纬度参数正确传递
- ✅ 地图中心定位到长按位置

---

#### 4.3 取消标注
**测试步骤：**
1. 长按地图
2. 点击"取消"按钮
3. 观察对话框关闭

**预期结果：**
- ✅ 对话框关闭
- ✅ 停留在地图页面
- ✅ 不跳转

---

### 五、标记跳转功能测试

#### 5.1 点击用户标注设施
**测试步骤：**
1. 在地图上找到用户标注的设施标记
2. 点击标记
3. 观察页面跳转

**预期结果：**
- ✅ 直接跳转到设施详情页
- ✅ 不显示底部抽屉
- ✅ 传递正确的设施ID

---

#### 5.2 点击POI设施
**测试步骤：**
1. 在地图上找到POI设施标记（腾讯地图数据）
2. 点击标记
3. 观察底部抽屉

**预期结果：**
- ✅ 底部抽屉展开
- ✅ 显示设施详情
- ✅ 不跳转页面

---

#### 5.3 点击问题标记
**测试步骤：**
1. 在地图上找到问题标记（红旗图标）
2. 点击标记
3. 观察页面跳转

**预期结果：**
- ✅ 跳转到问题详情页
- ✅ 传递正确的问题ID

---

## 🐛 常见问题排查

### 问题1：设施详情页加载失败
**可能原因：**
- 云函数未部署
- 设施ID不存在
- 网络问题

**排查步骤：**
1. 检查云函数是否部署成功
2. 检查传递的设施ID是否正确
3. 查看控制台错误信息

---

### 问题2：更新状态按钮不显示
**可能原因：**
- 用户权限不足
- 权限检查逻辑错误

**排查步骤：**
1. 检查用户类型（users集合中的userType字段）
2. 检查设施创建者（_openid字段）
3. 查看控制台日志

---

### 问题3：筛选不生效
**可能原因：**
- 云函数未接收到status参数
- 数据库查询条件错误

**排查步骤：**
1. 检查statusFilter数组是否正确
2. 查看云函数日志
3. 检查数据库查询条件

---

### 问题4：照片上传失败
**可能原因：**
- 云存储配额不足
- 照片文件过大
- 网络问题

**排查步骤：**
1. 检查云存储配额
2. 压缩照片大小
3. 重试上传

---

## ✅ 测试完成检查清单

### 设施详情页：
- [ ] 页面正常加载
- [ ] 信息完整显示
- [ ] 照片预览正常
- [ ] 状态历史正确
- [ ] 导航功能正常
- [ ] 下拉刷新有效

### 状态更新：
- [ ] 权限控制正确
- [ ] 面板正常弹出
- [ ] 状态选择正常
- [ ] 备注输入正常
- [ ] 照片上传成功
- [ ] 提交更新成功
- [ ] 历史记录更新

### 地图筛选：
- [ ] 面板正常弹出
- [ ] 单选筛选有效
- [ ] 多选筛选有效
- [ ] 清除筛选正常
- [ ] 徽章显示正确

### 长按标注：
- [ ] 对话框正常弹出
- [ ] 确认跳转正常
- [ ] 取消操作正常
- [ ] 坐标传递正确

### 标记跳转：
- [ ] 用户设施跳转详情
- [ ] POI设施显示抽屉
- [ ] 问题标记跳转详情

---

## 📊 测试报告模板

```
测试日期：____年__月__日
测试人员：__________
测试环境：微信开发者工具 / 真机

测试结果：
✅ 通过项：__ / 30
❌ 失败项：__ / 30
⚠️ 待修复：__ / 30

主要问题：
1. 
2. 
3. 

建议优化：
1. 
2. 
3. 

总体评价：
□ 优秀  □ 良好  □ 一般  □ 需改进
```

---

**文档版本**：v1.0  
**创建日期**：2026-02-02  
**最后更新**：2026-02-02

