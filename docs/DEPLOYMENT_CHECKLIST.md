# 登录/退出登录系统 - 部署清单

## ✅ 已完成的工作

### 1. 页面文件
- ✅ `pages/login/index.*` - 登录页面（4个文件）
- ✅ `pages/mine/index.*` - "我的"页面（4个文件）
- ✅ `pages/edit-profile/index.*` - 编辑资料页面（4个文件）

### 2. 云函数
- ✅ `cloudfunctions/login/index.js` - 获取 openid
- ✅ `cloudfunctions/updateUserInfo/index.js` - 保存用户信息

### 3. 应用配置
- ✅ `app.js` - 全局登录逻辑
- ✅ `app.json` - 页面路由配置
- ✅ `config/index.js` - 云环境配置

### 4. 文档
- ✅ `docs/LOGIN_SYSTEM.md` - 系统说明文档
- ✅ `docs/LOGIN_TEST_GUIDE.md` - 测试指南

## 📋 部署步骤

### 步骤 1: 部署云函数

#### 1.1 部署 login 云函数
```bash
# 在微信开发者工具中
1. 右键点击 cloudfunctions/login 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
```

#### 1.2 部署 updateUserInfo 云函数
```bash
# 在微信开发者工具中
1. 右键点击 cloudfunctions/updateUserInfo 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
```

### 步骤 2: 创建数据库集合

#### 2.1 创建 users 集合
```bash
1. 打开云开发控制台
2. 进入"数据库"
3. 点击"添加集合"
4. 集合名称：users
5. 点击"确定"
```

#### 2.2 设置权限
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

说明：
- 所有人可读（用于查看其他用户信息）
- 只有本人可写（只能修改自己的信息）

### 步骤 3: 配置云存储

#### 3.1 创建 avatars 文件夹
```bash
1. 打开云开发控制台
2. 进入"存储"
3. 点击"上传文件"
4. 创建 avatars 文件夹（用于存放用户头像）
```

#### 3.2 设置权限
```json
{
  "read": true,
  "write": true
}
```

说明：所有人可读写（用于上传和查看头像）

### 步骤 4: 验证配置

#### 4.1 检查云环境 ID
```javascript
// config/index.js
module.exports = {
  CLOUD_ENV: 'your-env-id', // 确认这里是正确的环境 ID
  // ...
};
```

#### 4.2 检查 app.js 初始化
```javascript
// app.js
onLaunch: function () {
  wx.cloud.init({
    env: config.CLOUD_ENV, // 使用配置文件中的环境 ID
    traceUser: true,
  });
}
```

### 步骤 5: 测试功能

按照 `docs/LOGIN_TEST_GUIDE.md` 中的步骤进行测试。

## 🔍 验证清单

### 云函数验证
- [ ] login 云函数已部署
- [ ] updateUserInfo 云函数已部署
- [ ] 云函数日志中没有错误

### 数据库验证
- [ ] users 集合已创建
- [ ] 权限规则已设置
- [ ] 可以正常读写数据

### 云存储验证
- [ ] avatars 文件夹已创建
- [ ] 权限规则已设置
- [ ] 可以正常上传文件

### 功能验证
- [ ] 首次登录成功
- [ ] 头像上传成功
- [ ] 昵称保存成功
- [ ] 编辑资料成功
- [ ] 退出登录成功
- [ ] 重新登录成功
- [ ] 数据持久化正常

## 🎯 核心功能说明

### 登录流程
```
用户点击登录 
  → 跳转登录页面 
  → 选择头像和输入昵称 
  → 获取 openid 
  → 上传头像到云存储 
  → 保存信息到数据库 
  → 更新本地缓存 
  → 返回"我的"页面
```

### 退出登录流程
```
用户点击退出登录 
  → 确认对话框 
  → 清除 openid 
  → 保留 userInfo（重要！）
  → 清空页面显示 
  → 显示未登录状态
```

### 重新登录流程
```
用户点击登录 
  → 跳转登录页面 
  → 自动填充之前的信息 
  → 可修改或直接保存 
  → 获取新的 openid 
  → 登录成功
```

## 🔑 关键设计决策

### 1. 退出登录保留 userInfo
**原因：** 用户重新登录时可以直接使用之前的头像和昵称，避免重复设置。

**实现：**
```javascript
// 只清除 openid
wx.removeStorageSync('openid');

// 不清除 userInfo
// wx.removeStorageSync('userInfo'); // 注释掉
```

### 2. 分离查看和编辑
**原因：** 避免误操作，符合用户习惯。

**实现：**
- "我的"页面：只显示，点击头像跳转
- "编辑资料"页面：专门用于修改

### 3. 使用微信官方推荐方式
**原因：** 符合最新的隐私保护规范。

**实现：**
```xml
<button open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
<input type="nickname" bindinput="onNicknameInput" />
```

## 📱 页面截图说明

### 未登录状态
- 显示紫色渐变的"点击登录"卡片
- 不显示任何用户数据

### 登录页面
- 头像选择区域（可点击）
- 昵称输入框
- "完成"按钮
- "暂时跳过"按钮

### 已登录状态
- 显示用户头像和昵称
- 显示"退出登录"按钮
- 显示统计数据
- 显示内容列表

### 编辑资料页面
- 顶部导航栏（取消/保存）
- 头像编辑区域
- 昵称编辑区域
- 提示信息

## 🐛 常见问题

### Q1: 云函数调用失败
**解决：**
1. 检查云函数是否已部署
2. 检查云环境 ID 是否正确
3. 查看云函数日志

### Q2: 头像上传失败
**解决：**
1. 检查云存储权限
2. 检查文件大小（建议 < 2MB）
3. 查看控制台错误信息

### Q3: 数据库写入失败
**解决：**
1. 检查 users 集合是否存在
2. 检查权限规则
3. 查看云函数日志

### Q4: 退出登录后数据没清空
**解决：**
1. 检查 `handleLogout` 方法
2. 确认 `setData` 正确执行
3. 检查 `isLoggedIn` 状态

## 📞 技术支持

如有问题，请查看：
1. `docs/LOGIN_SYSTEM.md` - 详细系统说明
2. `docs/LOGIN_TEST_GUIDE.md` - 测试指南
3. 微信开发者工具控制台
4. 云开发控制台日志

## 🎉 完成标志

当以下所有项都完成时，登录/退出登录系统即部署成功：

- ✅ 云函数部署完成
- ✅ 数据库集合创建完成
- ✅ 云存储配置完成
- ✅ 所有测试用例通过
- ✅ 真机测试通过

---

**部署日期：** __________
**部署人员：** __________
**环境 ID：** __________
**状态：** □ 开发环境  □ 测试环境  □ 生产环境








