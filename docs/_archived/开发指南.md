# 無界营造 - 开发指南

## 📚 目录

1. [开发环境配置](#开发环境配置)
2. [代码规范](#代码规范)
3. [模块使用说明](#模块使用说明)
4. [云函数开发](#云函数开发)
5. [数据库设计](#数据库设计)
6. [常用API](#常用api)
7. [调试技巧](#调试技巧)
8. [部署上线](#部署上线)

## 开发环境配置

### 必需工具
- 微信开发者工具（最新稳定版）
- Node.js 14.0.0+
- Git

### 推荐工具
- VS Code（代码编辑）
- Postman（API测试）
- Navicat（数据库管理）

### 环境变量配置

在 `config/index.js` 中配置：

```javascript
module.exports = {
  // 云开发环境ID
  cloudEnvId: 'your-env-id',
  
  // 腾讯地图密钥
  tencentMapKey: 'your-map-key',
  
  // 其他配置...
};
```

## 代码规范

### 命名规范

1. **文件命名**
   - 页面文件：小写字母+连字符（如 `issue-edit`）
   - 工具文件：小写字母+连字符（如 `cost-estimate.js`）
   - 组件文件：小写字母+连字符（如 `custom-button`）

2. **变量命名**
   - 驼峰命名法：`userName`, `projectId`
   - 常量：大写字母+下划线：`MAX_COUNT`, `API_URL`
   - 私有变量：下划线开头：`_privateVar`

3. **函数命名**
   - 动词开头：`getUserInfo`, `loadData`, `handleClick`
   - 事件处理：`on` 开头：`onLoad`, `onTap`, `onChange`

### 代码风格

```javascript
// ✅ 推荐写法
const getUserInfo = async (userId) => {
  try {
    const db = getDB();
    const res = await db.collection('users').doc(userId).get();
    return res.data;
  } catch (error) {
    console.error('获取用户信息失败:', error);
    return null;
  }
};

// ❌ 不推荐写法
function getUserInfo(userId){
  const db=wx.cloud.database()
  return db.collection('users').doc(userId).get().then(res=>{
    return res.data
  })
}
```

### 注释规范

```javascript
/**
 * 计算两点之间的距离
 * @param {number} lat1 - 起点纬度
 * @param {number} lon1 - 起点经度
 * @param {number} lat2 - 终点纬度
 * @param {number} lon2 - 终点经度
 * @returns {number} 距离（公里）
 */
function calculateDistance(lat1, lon1, lat2, lon2) {
  // 实现代码...
}
```

## 模块使用说明

### 1. 造价估算模块

```javascript
const costEstimate = require('../../utils/cost-estimate.js');

// 生成造价估算
const estimate = costEstimate.generateCostEstimate(
  '无障碍坡道',           // 分类
  { area: 10, length: 5 }, // 参数
  { description: '...' }   // AI诊断结果
);

console.log(estimate);
// {
//   projectName: '无障碍坡道改造',
//   category: '无障碍坡道',
//   materials: [...],
//   labor: [...],
//   costBreakdown: {
//     materialCost: 2000,
//     laborCost: 1000,
//     total: 3500,
//     ...
//   }
// }
```

### 2. 施工团队管理模块

```javascript
const constructionTeam = require('../../utils/construction-team.js');

// 匹配施工团队
const teams = await constructionTeam.matchConstructionTeams({
  category: '无障碍坡道',
  location: { latitude: 28.2, longitude: 113.0 },
  budget: 5000,
  urgency: 'normal',
});

// 创建施工项目
const projectId = await constructionTeam.createConstructionProject({
  issueId: 'xxx',
  solutionId: 'yyy',
  teamId: 'zzz',
  costEstimate: estimate,
  scheduledDate: '2026-02-01',
  estimatedDuration: 3,
  contactPerson: '张三',
  contactPhone: '13800138000',
});

// 更新施工进度
await constructionTeam.updateConstructionProgress(projectId, {
  progress: 50,
  milestone: '坡道基础施工完成',
  photos: ['cloud://xxx.jpg'],
  notes: '进展顺利',
});

// 提交评价
await constructionTeam.submitTeamReview(projectId, teamId, {
  rating: 5,
  quality: 5,
  timeliness: 5,
  communication: 5,
  professionalism: 5,
  comment: '施工质量很好',
  photos: ['cloud://xxx.jpg'],
});
```

### 3. 数据库操作模块

```javascript
const database = require('../../utils/database.js');

// 延迟初始化数据库
let db = null;
const getDB = () => {
  if (!db) {
    db = wx.cloud.database();
  }
  return db;
};

// 在函数中使用
someFunction: function() {
  const db = getDB();
  db.collection('posts').get()...
}
```

### 4. 地图服务模块

```javascript
const mapService = require('../../utils/map.js');

// 初始化地图SDK
mapService.initMapSDK('your-map-key');

// 搜索附近设施
const facilities = await mapService.searchNearby({
  keyword: '无障碍卫生间',
  location: { latitude: 28.2, longitude: 113.0 },
  radius: 1000,
});

// 路径规划
const route = await mapService.planRoute({
  from: { latitude: 28.2, longitude: 113.0 },
  to: { latitude: 28.3, longitude: 113.1 },
  mode: 'walking',
});
```

## 云函数开发

### 创建云函数

1. 在 `cloudfunctions` 目录下创建新文件夹
2. 创建 `index.js` 和 `package.json`
3. 编写云函数代码
4. 右键上传并部署

### 云函数示例

```javascript
// cloudfunctions/matchConstructionTeams/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  const { category, location, budget, urgency } = event;
  
  try {
    // 查询符合条件的施工团队
    const res = await db.collection('construction_teams')
      .where({
        specialties: _.in([category]),
        status: 'active',
      })
      .get();
    
    // 计算匹配度并排序
    const teams = res.data.map(team => ({
      ...team,
      matchScore: calculateMatchScore(team, event),
    })).sort((a, b) => b.matchScore - a.matchScore);
    
    return {
      success: true,
      teams: teams.slice(0, 10), // 返回前10个
    };
  } catch (error) {
    console.error('匹配失败:', error);
    return {
      success: false,
      error: error.message,
    };
  }
};

function calculateMatchScore(team, requirements) {
  // 匹配度计算逻辑...
  return score;
}
```

## 数据库设计

### 核心集合

#### 1. issues（问题记录）
```javascript
{
  _id: string,
  _openid: string,
  imageUrl: string,
  images: array,
  description: string,
  userSuggestion: string,
  category: string,
  contactPhone: string,
  location: GeoPoint,
  address: string,
  formattedAddress: string,
  aiSolution: string,
  status: string, // pending/in_progress/resolved
  createTime: Date,
  userInfo: {
    nickName: string,
    avatarUrl: string,
  }
}
```

#### 2. solutions（解决方案）
```javascript
{
  _id: string,
  _openid: string,
  title: string,
  category: string,
  status: string,
  beforeImg: string,
  afterImg: string,
  aiAnalysis: string,
  userSuggestion: string,
  viewCount: number,
  collectCount: number,
  location: GeoPoint,
  address: string,
  sourceIssueId: string,
  createTime: Date,
  userInfo: object,
}
```

#### 3. construction_projects（施工项目）
```javascript
{
  _id: string,
  _openid: string,
  issueId: string,
  solutionId: string,
  teamId: string,
  costEstimate: object,
  scheduledDate: string,
  estimatedDuration: number,
  contactPerson: string,
  contactPhone: string,
  status: string, // pending/confirmed/in_progress/completed/cancelled
  progress: number,
  milestones: array,
  photos: array,
  reviewed: boolean,
  reviewRating: number,
  createdAt: Date,
  updatedAt: Date,
}
```

#### 4. construction_teams（施工团队）
```javascript
{
  _id: string,
  name: string,
  contact: string,
  phone: string,
  address: string,
  location: GeoPoint,
  specialties: array,
  certifications: array,
  experience: number,
  completedProjects: number,
  rating: number,
  reviewCount: number,
  priceRange: string,
  status: string, // active/inactive
  createdAt: Date,
  updatedAt: Date,
}
```

### 索引设计

```javascript
// issues 集合
db.collection('issues').createIndex({
  keys: { location: '2dsphere' },
  name: 'location_index',
});

db.collection('issues').createIndex({
  keys: { category: 1, status: 1 },
  name: 'category_status_index',
});

// construction_teams 集合
db.collection('construction_teams').createIndex({
  keys: { location: '2dsphere' },
  name: 'location_index',
});

db.collection('construction_teams').createIndex({
  keys: { rating: -1, completedProjects: -1 },
  name: 'rating_projects_index',
});
```

## 常用API

### 微信API

```javascript
// 获取用户位置
wx.getLocation({
  type: 'gcj02',
  success: (res) => {
    console.log(res.latitude, res.longitude);
  },
});

// 选择图片
wx.chooseImage({
  count: 9,
  sizeType: ['compressed'],
  sourceType: ['album', 'camera'],
  success: (res) => {
    console.log(res.tempFilePaths);
  },
});

// 上传文件到云存储
wx.cloud.uploadFile({
  cloudPath: 'images/xxx.jpg',
  filePath: tempFilePath,
  success: (res) => {
    console.log(res.fileID);
  },
});

// 调用云函数
wx.cloud.callFunction({
  name: 'functionName',
  data: { key: 'value' },
  success: (res) => {
    console.log(res.result);
  },
});
```

### 云开发API

```javascript
// 数据库查询
const db = wx.cloud.database();
const _ = db.command;

// 简单查询
db.collection('posts').get();

// 条件查询
db.collection('posts')
  .where({ status: 'published' })
  .orderBy('createTime', 'desc')
  .limit(20)
  .get();

// 地理位置查询
db.collection('issues')
  .where({
    location: _.geoNear({
      geometry: new db.Geo.Point(longitude, latitude),
      maxDistance: 5000,
      minDistance: 0,
    }),
  })
  .get();

// 聚合查询
db.collection('posts')
  .aggregate()
  .match({ status: 'published' })
  .group({
    _id: '$category',
    count: _.sum(1),
  })
  .end();
```

## 调试技巧

### 1. 控制台调试

```javascript
// 使用 console.log 输出调试信息
console.log('变量值:', variable);
console.error('错误信息:', error);
console.warn('警告信息:', warning);

// 使用 console.table 输出表格
console.table(arrayData);
```

### 2. 断点调试

在微信开发者工具中：
1. 点击行号设置断点
2. 刷新页面触发断点
3. 使用调试面板查看变量值

### 3. 网络请求调试

在微信开发者工具的 Network 面板中：
- 查看所有网络请求
- 检查请求参数和响应数据
- 分析请求耗时

### 4. 云函数调试

```javascript
// 在云函数中添加日志
console.log('云函数参数:', event);
console.log('用户openid:', context.OPENID);

// 在云开发控制台查看日志
// 云开发 -> 云函数 -> 日志
```

## 部署上线

### 1. 代码检查

```bash
# 检查代码规范
npm run lint

# 运行测试
npm run test
```

### 2. 云函数部署

1. 右键点击云函数目录
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

### 3. 数据库初始化

1. 创建所有必需的集合
2. 设置索引
3. 导入初始数据

### 4. 小程序提交审核

1. 点击"上传"按钮
2. 填写版本号和项目备注
3. 在微信公众平台提交审核
4. 等待审核通过后发布

### 5. 版本管理

```bash
# 创建新版本标签
git tag -a v2.0.0 -m "版本 2.0.0"
git push origin v2.0.0

# 创建发布分支
git checkout -b release/v2.0.0
```

## 性能优化建议

### 1. 图片优化
- 使用压缩后的图片
- 懒加载图片
- 使用 WebP 格式

### 2. 数据加载优化
- 分页加载数据
- 使用缓存
- 预加载关键数据

### 3. 代码优化
- 减少不必要的 setData
- 避免频繁的数据库查询
- 使用防抖和节流

### 4. 云函数优化
- 合并多个小请求
- 使用云函数缓存
- 优化数据库查询

## 常见问题解决

### 1. 云开发初始化失败
**解决方案**：确保所有页面使用延迟初始化模式

### 2. 地图不显示
**解决方案**：检查地图密钥和权限配置

### 3. 图片上传失败
**解决方案**：检查图片大小和云存储配额

### 4. 云函数超时
**解决方案**：优化云函数逻辑，增加超时时间

---

**文档版本**：v1.0.0  
**最后更新**：2026-01-29  
**维护者**：技术组









