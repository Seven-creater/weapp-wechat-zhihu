# åˆ†ç±»æ˜¾ç¤ºä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°
å¸–å­è¯¦æƒ…é¡µæ˜¾ç¤ºçš„æ˜¯åˆ†ç±»IDï¼ˆå¦‚ `steps`ï¼‰ï¼Œè€Œä¸æ˜¯åˆ†ç±»åç§°ï¼ˆå¦‚"å°é˜¶"ï¼‰ã€‚

---

## ğŸ” é—®é¢˜åŸå› 

### æ•°æ®ç»“æ„
å¸–å­æ•°æ®åŒ…å«ä¸¤ä¸ªå­—æ®µï¼š
- `category`: åˆ†ç±»IDï¼ˆå¦‚ `parking`, `steps`ï¼‰
- `categoryName`: åˆ†ç±»åç§°ï¼ˆå¦‚"æ— éšœç¢åœè½¦ä½"ã€"å°é˜¶"ï¼‰

### æ˜¾ç¤ºé”™è¯¯
å¸–å­è¯¦æƒ…é¡µçš„ WXML ä½¿ç”¨äº† `{{post.category}}`ï¼Œå¯¼è‡´æ˜¾ç¤ºçš„æ˜¯IDè€Œä¸æ˜¯åç§°ã€‚

---

## âœ… ä¿®å¤å†…å®¹

### 1. ä¿®å¤å¸–å­è¯¦æƒ…é¡µæ˜¾ç¤º

**æ–‡ä»¶**: `pages/post-detail/index.wxml`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 18-23 è¡Œ

**ä¿®æ”¹å‰**:
```xml
<view class="tag-badge" wx:if="{{post.type === 'issue'}}">
  <text class="tag-icon">ğŸš§</text>
  <text>{{post.category || 'éšæ‰‹æ‹'}}</text>
</view>
<view class="tag-badge" wx:elif="{{post.type === 'case'}}">
  <text class="tag-icon">ğŸ—ï¸</text>
  <text>{{post.category || 'æ¡ˆä¾‹'}}</text>
</view>
```

**ä¿®æ”¹å**:
```xml
<view class="tag-badge" wx:if="{{post.type === 'issue'}}">
  <text class="tag-icon">ğŸš§</text>
  <text>{{post.categoryName || 'éšæ‰‹æ‹'}}</text>
</view>
<view class="tag-badge" wx:elif="{{post.type === 'case'}}">
  <text class="tag-icon">ğŸ—ï¸</text>
  <text>{{post.categoryName || 'æ¡ˆä¾‹'}}</text>
</view>
```

---

## ğŸ”„ æ•°æ®æµæ£€æŸ¥

### 1. å‘å¸ƒé¡µé¢ï¼ˆå·²æ­£ç¡®ï¼‰
**æ–‡ä»¶**: `pages/issue-edit/index.js`

å‘å¸ƒæ—¶åŒæ—¶ä¿å­˜IDå’Œåç§°ï¼š
```javascript
category: this.data.selectedCategoryId,  // ä¿å­˜åˆ†ç±»ID
categoryName: this.data.selectedCategory,  // ä¿å­˜åˆ†ç±»åç§°
```

### 2. ç¤¾åŒºé¡µé¢ï¼ˆå·²æ­£ç¡®ï¼‰
**æ–‡ä»¶**: `pages/community/community.js`

æ˜¾ç¤ºæ—¶ä¼˜å…ˆä½¿ç”¨åç§°ï¼š
```javascript
const tag = p.categoryName || 
  p.category ||
  (p.type === "case" ? "æ¡ˆä¾‹" : p.type === "issue" ? "é—®é¢˜åé¦ˆ" : "æ—¥å¸¸");
```

### 3. åœ°å›¾é¡µé¢ï¼ˆå·²æ­£ç¡®ï¼‰
**æ–‡ä»¶**: `pages/map-view/index.js`

æ ‡è®°æ°”æ³¡æ˜¾ç¤ºåç§°ï¼š
```javascript
const categoryLabel = post.categoryName || getCategoryName(post.category) || 'è·¯éšœ';
```

### 4. äº‘å‡½æ•°ç­›é€‰ï¼ˆå·²å…¼å®¹ï¼‰
**æ–‡ä»¶**: `cloudfunctions/getPublicData/index.js`

åŒæ—¶åŒ¹é…IDå’Œåç§°ï¼š
```javascript
if (category) {
  where.category = _.or([
    _.eq(category),  // åŒ¹é…æ–°æ•°æ®çš„ID
    _.eq(getCategoryNameById(category))  // åŒ¹é…æ—§æ•°æ®çš„åç§°
  ]);
}
```

---

## ğŸ“Š æ•°æ®å…¼å®¹æ€§

### æ–°æ•°æ®æ ¼å¼
```json
{
  "category": "parking",
  "categoryName": "æ— éšœç¢åœè½¦ä½"
}
```

### æ—§æ•°æ®æ ¼å¼
```json
{
  "category": "æ— éšœç¢åœè½¦ä½"
}
```

### å…¼å®¹ç­–ç•¥
æ‰€æœ‰æ˜¾ç¤ºé€»è¾‘éƒ½ä¼˜å…ˆä½¿ç”¨ `categoryName`ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ `category`ï¼Œç¡®ä¿æ–°æ—§æ•°æ®éƒ½èƒ½æ­£ç¡®æ˜¾ç¤ºã€‚

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- å¸–å­è¯¦æƒ…é¡µæ˜¾ç¤ºï¼š`steps` âŒ
- ç”¨æˆ·çœ‹åˆ°çš„æ˜¯æŠ€æœ¯IDï¼Œä¸å‹å¥½

### ä¿®å¤å
- å¸–å­è¯¦æƒ…é¡µæ˜¾ç¤ºï¼š`å°é˜¶` âœ…
- ç”¨æˆ·çœ‹åˆ°çš„æ˜¯ä¸­æ–‡åç§°ï¼Œæ¸…æ™°æ˜“æ‡‚

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. **`pages/post-detail/index.wxml`** - ä¿®å¤åˆ†ç±»æ˜¾ç¤º

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. æ–°æ•°æ®æµ‹è¯•
- [ ] å‘å¸ƒæ–°å¸–å­ï¼Œé€‰æ‹©"å°é˜¶"åˆ†ç±»
- [ ] æŸ¥çœ‹å¸–å­è¯¦æƒ…ï¼Œç¡®è®¤æ˜¾ç¤º"å°é˜¶"è€Œä¸æ˜¯"steps"
- [ ] åœ¨ç¤¾åŒºé¡µé¢æŸ¥çœ‹ï¼Œç¡®è®¤æ ‡ç­¾æ˜¾ç¤ºæ­£ç¡®

### 2. æ—§æ•°æ®æµ‹è¯•
- [ ] æŸ¥çœ‹æ—§çš„å¸–å­è¯¦æƒ…
- [ ] ç¡®è®¤æ—§æ•°æ®ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤ºåˆ†ç±»åç§°
- [ ] åœ¨æ¡ˆä¾‹ç­›é€‰ä¸­æµ‹è¯•æ—§æ•°æ®èƒ½å¦è¢«æ­£ç¡®ç­›é€‰

### 3. å…¨æµç¨‹æµ‹è¯•
- [ ] å‘å¸ƒå¸–å­ â†’ æŸ¥çœ‹è¯¦æƒ… â†’ æ˜¾ç¤ºæ­£ç¡®
- [ ] ç¤¾åŒºåˆ—è¡¨ â†’ ç‚¹å‡»å¸–å­ â†’ è¯¦æƒ…æ˜¾ç¤ºæ­£ç¡®
- [ ] åœ°å›¾æ ‡è®° â†’ ç‚¹å‡»è·³è½¬ â†’ è¯¦æƒ…æ˜¾ç¤ºæ­£ç¡®
- [ ] æ¡ˆä¾‹ç­›é€‰ â†’ ç‚¹å‡»å¸–å­ â†’ è¯¦æƒ…æ˜¾ç¤ºæ­£ç¡®

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆåŒæ—¶ä¿å­˜IDå’Œåç§°ï¼Ÿ

1. **IDç”¨äºç­›é€‰**ï¼šæ•°æ®åº“æŸ¥è¯¢æ—¶ä½¿ç”¨IDæ›´é«˜æ•ˆ
2. **åç§°ç”¨äºæ˜¾ç¤º**ï¼šç”¨æˆ·ç•Œé¢æ˜¾ç¤ºä¸­æ–‡åç§°æ›´å‹å¥½
3. **å…¼å®¹æ€§**ï¼šæ”¯æŒæ—§æ•°æ®ï¼ˆåªæœ‰åç§°ï¼‰å’Œæ–°æ•°æ®ï¼ˆID+åç§°ï¼‰

### æ•°æ®è¿ç§»å»ºè®®

å¦‚æœéœ€è¦ç»Ÿä¸€æ•°æ®æ ¼å¼ï¼Œå¯ä»¥è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬ï¼š

```javascript
// æ•°æ®è¿ç§»è„šæœ¬ï¼ˆå¯é€‰ï¼‰
const { getCategoryId } = require('../../utils/categories.js');

async function migrateOldData() {
  const db = wx.cloud.database();
  const posts = await db.collection('posts').get();
  
  for (const post of posts.data) {
    // å¦‚æœåªæœ‰categoryï¼ˆåç§°ï¼‰ï¼Œè¡¥å……categoryId
    if (post.category && !post.categoryName) {
      const categoryId = getCategoryId(post.category);
      if (categoryId) {
        await db.collection('posts').doc(post._id).update({
          data: {
            categoryName: post.category,
            category: categoryId
          }
        });
      }
    }
  }
}
```

---

## âœ¨ ä¼˜åŒ–å»ºè®®

### 1. ç»Ÿä¸€å­—æ®µå‘½å
å»ºè®®å°†æ¥ç»Ÿä¸€ä½¿ç”¨ï¼š
- `categoryId`: åˆ†ç±»ID
- `categoryName`: åˆ†ç±»åç§°

å½“å‰ä½¿ç”¨ `category` å­˜å‚¨IDå¯èƒ½ä¼šé€ æˆæ··æ·†ã€‚

### 2. æ·»åŠ æ•°æ®éªŒè¯
åœ¨å‘å¸ƒæ—¶éªŒè¯åˆ†ç±»IDå’Œåç§°çš„å¯¹åº”å…³ç³»ï¼š
```javascript
const { getCategoryName } = require('../../utils/categories.js');

// éªŒè¯åˆ†ç±»
if (categoryId) {
  const expectedName = getCategoryName(categoryId);
  if (categoryName !== expectedName) {
    console.warn('åˆ†ç±»åç§°ä¸åŒ¹é…');
  }
}
```

### 3. ç¼“å­˜ä¼˜åŒ–
å¯¹äºé¢‘ç¹ä½¿ç”¨çš„åˆ†ç±»æ˜ å°„ï¼Œå¯ä»¥è€ƒè™‘ç¼“å­˜ï¼š
```javascript
const categoryCache = new Map();

function getCategoryNameCached(id) {
  if (!categoryCache.has(id)) {
    categoryCache.set(id, getCategoryName(id));
  }
  return categoryCache.get(id);
}
```

---

## ğŸ“… å®Œæˆæ—¶é—´
2026å¹´2æœˆ4æ—¥

## ğŸ‘¨â€ğŸ’» å¼€å‘è€…
AI Assistant (Claude 4.5 Sonnet)

---

**ä¿®å¤å®Œæˆï¼ğŸ‰**

ç°åœ¨å¸–å­è¯¦æƒ…é¡µä¼šæ­£ç¡®æ˜¾ç¤ºåˆ†ç±»åç§°ï¼ˆå¦‚"å°é˜¶"ï¼‰ï¼Œè€Œä¸æ˜¯åˆ†ç±»IDï¼ˆå¦‚"steps"ï¼‰ã€‚

